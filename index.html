<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KAIROS Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }
        .no-spinner::-webkit-outer-spin-button,
        .no-spinner::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .no-spinner {
            -moz-appearance: textfield;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 250px; 
            max-height: 280px;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <div id="app" class="max-w-md mx-auto bg-gray-900 min-h-screen">
        <header class="sticky top-0 bg-gray-900 bg-opacity-80 backdrop-blur-md z-10 p-4 pt-6 flex justify-between items-center">
            <h1 class="text-xl font-bold text-white">KAIROS</h1>
        </header>

        <main class="p-4 space-y-6">
            <section id="clocks">
                <h2 class="text-lg font-semibold mb-3 text-blue-300">Rel√≥gios Globais</h2>
                <div class="grid grid-cols-2 sm:grid-cols-3 gap-4">
                    <!-- Rel√≥gios s√£o injetados aqui pelo JS -->
                </div>
            </section>

            <section id="sessions">
                <h2 class="text-lg font-semibold mb-3 text-blue-300">Sess√µes de Mercado</h2>
                <p class="text-sm text-gray-400 mb-4">
                    Acompanhe o estado de abertura dos principais mercados globais, com hor√°rios e contadores ajustados para o fuso de Bras√≠lia (BRT).
                </p>
                <div class="space-y-4">
                    <!-- Sess√µes s√£o injetadas aqui pelo JS -->
                </div>
                <div class="mt-4 bg-gray-800 p-4 rounded-xl">
                    <h3 class="text-md font-medium text-center text-gray-300 mb-2">Sobreposi√ß√£o de Sess√µes (BRT)</h3>
                    <div class="chart-container">
                        <canvas id="sessionsChart"></canvas>
                    </div>
                </div>
            </section>

            <div class="space-y-6">
                <section id="time-converter">
                    <h2 class="text-lg font-semibold mb-3 text-blue-300">Conversor de Hor√°rio</h2>
                    <p class="text-sm text-gray-400 mb-4">Insira um hor√°rio em qualquer mercado para ver a correspond√™ncia nos outros centros financeiros instantaneamente.</p>
                    <div class="bg-gray-800 p-4 rounded-xl space-y-4">
                        <div class="flex items-center space-x-2">
                            <input type="time" id="time-input" class="bg-gray-700 text-white rounded-lg p-2 w-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <select id="timezone-select" class="bg-gray-700 text-white rounded-lg p-2 w-full focus:outline-none focus:ring-2 focus:ring-blue-500"></select>
                        </div>
                        <div id="converted-times" class="text-center text-gray-300 space-y-1"></div>
                    </div>
                </section>

                <section id="currency-converter">
                    <h2 class="text-lg font-semibold mb-3 text-blue-300">Conversor Cambial</h2>
                    <p class="text-sm text-gray-400 mb-4">Cota√ß√µes em tempo real. Digite um valor em qualquer moeda para converter para as demais. As taxas s√£o atualizadas a cada minuto.</p>
                    <div id="currency-list" class="bg-gray-800 p-4 rounded-xl space-y-3"></div>
                </section>

                <section id="alerts">
                    <h2 class="text-lg font-semibold mb-3 text-blue-300">Alertas Inteligentes</h2>
                    <p class="text-sm text-gray-400 mb-4">Configure notifica√ß√µes para aberturas de sess√£o e eventos econ√≥micos de alta volatilidade.</p>
                    <div class="bg-gray-800 p-4 rounded-xl space-y-4">
                        <div>
                            <h3 class="font-medium text-white mb-2">Alertas de Sess√£o</h3>
                            <div id="session-alerts" class="space-y-2"></div>
                        </div>
                        <div>
                            <h3 class="font-medium text-white mb-2">Pr√≥ximos Eventos de Volatilidade</h3>
                            <div id="economic-events" class="space-y-2 text-sm"></div>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-10 right-10 flex items-center bg-blue-500 text-white py-3 px-5 rounded-lg shadow-lg transform translate-x-[150%] transition-transform duration-500 ease-in-out">
        <span id="toast-icon" class="mr-3 text-xl">üîî</span>
        <span id="toast-message"></span>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const markets = [
                { id: 'cme', name: 'CME (EUA)', flag: 'üá∫üá∏', timeZone: 'America/Chicago' },
                { id: 'eurex', name: 'Eurex (EUR)', flag: 'üá™üá∫', timeZone: 'Europe/Berlin' },
                { id: 'liffe', name: 'LIFFE (UK)', flag: 'üá¨üáß', timeZone: 'Europe/London' },
                { id: 'jpx', name: 'JPX (JAP)', flag: 'üáØüáµ', timeZone: 'Asia/Tokyo' },
                { id: 'b3', name: 'B3 (BRA)', flag: 'üáßüá∑', timeZone: 'America/Sao_Paulo' }
            ];

            const currencies = [
                { code: 'BRL', name: 'Real', flag: 'üáßüá∑' }, { code: 'USD', name: 'D√≥lar', flag: 'üá∫üá∏' },
                { code: 'EUR', name: 'Euro', flag: 'üá™üá∫' }, { code: 'GBP', name: 'Libra', flag: 'üá¨üáß' },
                { code: 'CHF', name: 'Franco', flag: 'üá®üá≠' }
            ];

            const economicEventsMock = [
                { time: '10:30', event: 'CPI (EUA)', impact: 3 }, { time: '15:00', event: 'Discurso da Fed', impact: 3 },
                { time: 'Amanh√£ 09:30', event: 'Payroll (EUA)', impact: 3 },
            ];

            let currencyRates = {};
            let alertSettings = { cme: true, eurex: true, liffe: true, jpx: true, b3: true };
            const triggeredAlerts = new Set();
            let audioContext;

            function getUtcOffset(timeZone) {
                try {
                    const now = new Date();
                    const formatter = new Intl.DateTimeFormat('en-US', { timeZone, timeZoneName: 'shortOffset' });
                    const parts = formatter.formatToParts(now);
                    const offsetPart = parts.find(p => p.type === 'timeZoneName');
                    return offsetPart ? offsetPart.value.replace('GMT', 'UTC') : 'UTC';
                } catch (e) { return 'UTC'; }
            }

            function formatTime(date) {
                return date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit', hour12: false });
            }

            function renderClocks() {
                const clocksContainer = document.querySelector('#clocks .grid');
                if (!clocksContainer) return;
                clocksContainer.innerHTML = ''; 

                markets.forEach(market => {
                    const now = new Date();
                    const marketTime = new Date(now.toLocaleString('en-US', { timeZone: market.timeZone }));
                    const clockDiv = `
                        <div class="bg-gray-800 p-3 rounded-xl shadow flex flex-col items-center justify-center">
                            <span class="text-md text-gray-400">${market.flag} ${market.name}</span>
                            <span class="font-bold text-xl text-white mt-2">${formatTime(marketTime)}</span>
                            <span class="text-xs text-gray-500 mt-1">${getUtcOffset(market.timeZone)}</span>
                        </div>`;
                    clocksContainer.innerHTML += clockDiv;
                });
            }

            function getCountdown(targetDate) {
                const now = new Date();
                const diff = targetDate.getTime() - now.getTime();
                if (diff < 0) return '00:00:00';
                const totalSeconds = Math.floor(diff / 1000);
                const days = Math.floor(totalSeconds / 86400);
                const hours = String(Math.floor((totalSeconds % 86400) / 3600)).padStart(2, '0');
                const minutes = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, '0');
                const seconds = String(totalSeconds % 60).padStart(2, '0');
                return days > 0 ? `${days}d ${hours}:${minutes}:${seconds}` : `${hours}:${minutes}:${seconds}`;
            }

            function renderSessions() {
                const sessionsContainer = document.getElementById('sessions')?.querySelector('.space-y-4');
                if (!sessionsContainer) return;
                sessionsContainer.innerHTML = '';
                const brtTimeZone = 'America/Sao_Paulo';
                const nowBRT = new Date(new Date().toLocaleString('en-US', { timeZone: brtTimeZone }));
                const nowDay = nowBRT.getDay();
                const nowTime = nowBRT.getHours() + nowBRT.getMinutes() / 60;

                const marketColors = {
                    b3: '#22c55e', cme: '#3b82f6', eurex: '#3b82f6',
                    liffe: '#ef4444', jpx: '#ffffff'
                };
                const closedColor = '#6b7280';

                markets.forEach(market => {
                    let statusText = 'Fechado', statusColor = 'text-red-400', countdownText = '', displayTimes = '';
                    let sessionStart, sessionEnd;

                    const setTime = (date, h, m) => { const d = new Date(date); d.setHours(h, m, 0, 0); return d; };
                    
                    switch (market.id) {
                        case 'b3':
                            displayTimes = '09:45 - 18:25 BRT';
                            if ([1,2,3,4,5].includes(nowDay)) {
                                sessionStart = setTime(nowBRT, 9, 45);
                                sessionEnd = setTime(nowBRT, 18, 25);
                            }
                            break;
                        case 'cme':
                            displayTimes = 'Dom 19h - Sex 18h BRT';
                            const isAfterOpen = nowDay > 0 || (nowDay === 0 && nowTime >= 19);
                            const isBeforeClose = nowDay < 5 || (nowDay === 5 && nowTime < 18);
                            if (isAfterOpen && isBeforeClose) {
                                sessionStart = setTime(nowBRT, 19, 0);
                                if (nowTime < 19) sessionStart.setDate(sessionStart.getDate() - 1);
                                sessionEnd = setTime(nowBRT, 18, 0);
                                if (nowTime >= 19) sessionEnd.setDate(sessionEnd.getDate() + 1);
                            }
                            break;
                        case 'eurex':
                            displayTimes = '03:15 - 17:00 BRT';
                            if ([1,2,3,4,5].includes(nowDay)) {
                                sessionStart = setTime(nowBRT, 3, 15);
                                sessionEnd = setTime(nowBRT, 17, 0);
                            }
                            break;
                        case 'liffe':
                            displayTimes = '04:00 - 18:00 BRT';
                            if ([1,2,3,4,5].includes(nowDay)) {
                                sessionStart = setTime(nowBRT, 4, 0);
                                sessionEnd = setTime(nowBRT, 18, 0);
                            }
                            break;
                        case 'jpx':
                            displayTimes = '21:00 - 07:00 BRT';
                            const isOpen = (nowDay !== 5 && nowDay !== 6 && nowTime >= 21) || (nowDay !== 6 && nowDay !== 0 && nowTime < 7);
                            if (isOpen) {
                                if (nowTime >= 21) {
                                    sessionStart = setTime(nowBRT, 21, 0);
                                    sessionEnd = setTime(nowBRT, 7, 0);
                                    sessionEnd.setDate(sessionEnd.getDate() + 1);
                                } else {
                                    sessionStart = setTime(nowBRT, 21, 0);
                                    sessionStart.setDate(sessionStart.getDate() - 1);
                                    sessionEnd = setTime(nowBRT, 7, 0);
                                }
                            }
                            break;
                    }

                    if (sessionStart && sessionEnd) {
                        if (nowBRT >= sessionStart && nowBRT < sessionEnd) {
                            statusText = 'Aberto'; statusColor = 'text-green-400';
                            countdownText = `Fecha em ${getCountdown(sessionEnd)}`;
                            if (market.id === 'cme' && nowBRT.getHours() === 18) {
                                statusText = 'Pausa'; statusColor = 'text-yellow-400';
                                countdownText = `Volta em ${getCountdown(setTime(new Date(nowBRT), 19, 0))}`;
                            }
                            if (market.id === 'jpx' && nowTime >= 3.5 && nowTime < 4.5) {
                                statusText = 'Pausa'; statusColor = 'text-yellow-400';
                                countdownText = `Volta em ${getCountdown(setTime(new Date(nowBRT), 4, 30))}`;
                            }
                        } else if (nowBRT < sessionStart) {
                             countdownText = `Abre em ${getCountdown(sessionStart)}`;
                        }
                    } 
                    if (!countdownText) {
                         // L√≥gica para encontrar a pr√≥xima sess√£o pode ser adicionada aqui
                    }

                    let progressWidth = 0;
                    let progressBarColor = closedColor;
                    if (statusText === 'Aberto') {
                        const sessionDuration = sessionEnd.getTime() - sessionStart.getTime();
                        const elapsedTime = nowBRT.getTime() - sessionStart.getTime();
                        const remainingPercentage = 100 - (elapsedTime / sessionDuration) * 100;
                        progressWidth = Math.max(0, remainingPercentage);
                        progressBarColor = marketColors[market.id];
                    } else if (nowBRT < sessionStart) {
                        progressWidth = 100;
                    }

                    const progressBarHTML = `
                        <div class="bg-gray-700 rounded-full h-2 w-full mt-2 overflow-hidden">
                            <div class="h-2 rounded-full transition-all duration-500" style="width: ${progressWidth}%; background-color: ${progressBarColor};"></div>
                        </div>`;

                    const sessionDiv = `
                        <div class="bg-gray-800 p-4 rounded-xl shadow">
                             <div class="flex justify-between items-center">
                                <div>
                                    <span class="font-medium text-white">${market.flag} ${market.name}</span>
                                    <span class="text-sm text-gray-400 ml-2 block sm:inline-block sm:ml-2">(${displayTimes})</span>
                                </div>
                                <div class="text-right">
                                    <span class="text-xs ${statusColor} block">${statusText}</span>
                                    <span class="text-sm font-semibold text-gray-300">${countdownText || ''}</span>
                                </div>
                            </div>
                            ${progressBarHTML}
                        </div>`;
                    sessionsContainer.innerHTML += sessionDiv;
                });
            }

            let sessionsChart;
            function renderSessionsChart() {
                const ctx = document.getElementById('sessionsChart')?.getContext('2d');
                if(!ctx) return;
                
                const nowBRT = new Date(new Date().toLocaleString('en-US', { timeZone: 'America/Sao_Paulo' }));
                const nowHour = nowBRT.getHours() + nowBRT.getMinutes() / 60;
                
                const marketIntervals = {
                    'liffe': { flag: 'üá¨üáß', label: 'GB', name: 'LIFFE (UK)', intervals: [[4, 18]], openColor: '#ef4444' },
                    'cme': { flag: 'üá∫üá∏', label: 'US', name: 'CME (EUA)', intervals: [[0, 18], [19, 24]], openColor: '#3b82f6' },
                    'eurex': { flag: 'üá™üá∫', label: 'EU', name: 'Eurex (EUR)', intervals: [[3.25, 17]], openColor: '#3b82f6' },
                    'jpx': { flag: 'üáØüáµ', label: 'JP', name: 'JPX (JAP)', intervals: [[0, 3.5], [4.5, 7], [21, 24]], openColor: '#ffffff' },
                    'b3': { flag: 'üáßüá∑', label: 'BR', name: 'B3 (BRA)', intervals: [[9.75, 18.416]], openColor: '#22c55e' },
                    closedColor: '#6b7280',
                    openThickness: 16,
                    closedThickness: 8
                };
                
                const orderedData = ['liffe', 'cme', 'eurex', 'jpx', 'b3'].map(id => marketIntervals[id]);

                const isMarketCurrentlyOpen = (market, time) => {
                    const nowDay = nowBRT.getDay();
                    if (market.name.includes('B3') || market.name.includes('LIFFE') || market.name.includes('Eurex')) {
                        if (![1,2,3,4,5].includes(nowDay)) return false; 
                    }
                    if (market.name.includes('CME')) {
                         const isAfterOpen = nowDay > 0 || (nowDay === 0 && time >= 19);
                         const isBeforeClose = nowDay < 5 || (nowDay === 5 && time < 18);
                         if (! (isAfterOpen && isBeforeClose)) return false;
                    }
                     if (market.name.includes('JPX')) {
                        const isOpen = (nowDay !== 5 && nowDay !== 6 && time >= 21) || (nowDay !== 6 && nowDay !== 0 && time < 7);
                        if (!isOpen) return false;
                    }
                    return market.intervals.some(interval => time >= interval[0] && time < interval[1]);
                };

                // ‚úÖ L√≥gica de datasets corrigida para alinhamento
                const dataForChart = [];
                const backgroundColors = [];
                const barThicknesses = [];

                orderedData.forEach(market => {
                    const isActive = isMarketCurrentlyOpen(market, nowHour);
                    market.intervals.forEach(interval => {
                        dataForChart.push({ x: interval, y: market.name });
                        backgroundColors.push(isActive ? market.openColor : marketIntervals.closedColor);
                        barThicknesses.push(isActive ? marketIntervals.openThickness : marketIntervals.closedThickness);
                    });
                });

                const datasets = [{
                    data: dataForChart,
                    backgroundColor: backgroundColors,
                    barThickness: barThicknesses,
                    borderColor: 'transparent',
                    borderRadius: 5
                }];
                
                const customLabelsPlugin = {
                    id: 'customLabels',
                    afterDraw: (chart) => {
                        const { ctx, chartArea: { top, bottom, left }, scales: { x, y } } = chart;
                        ctx.save();

                        orderedData.forEach((market, index) => {
                             if (!market) return;
                            ctx.font = '14px Roboto';
                            ctx.fillStyle = '#E5E7EB';
                            ctx.textAlign = 'center';
                            ctx.textBaseline = 'middle';
                            const yPos = y.getPixelForValue(index);
                            ctx.fillText(market.label, left - 25, yPos);
                        });
                        
                        const currentHour = nowBRT.getHours() + nowBRT.getMinutes() / 60;
                        const anyMarketOpen = orderedData.some(market => isMarketCurrentlyOpen(market, currentHour));
                        const xPos = x.getPixelForValue(currentHour);

                        if (xPos >= x.left && xPos <= x.right) {
                            ctx.beginPath();
                            ctx.strokeStyle = anyMarketOpen ? '#22c55e' : 'rgba(255, 255, 255, 0.7)';
                            ctx.lineWidth = anyMarketOpen ? 2.5 : 1.5;
                            ctx.setLineDash([4, 4]);
                            ctx.moveTo(xPos, top);
                            ctx.lineTo(xPos, bottom);
                            ctx.stroke();
                            ctx.setLineDash([]);
                        }
                        ctx.restore();
                    }
                };
                
                if (sessionsChart) sessionsChart.destroy();

                sessionsChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: orderedData.map(d => d.name),
                        datasets: datasets // ‚úÖ Usando o novo dataset √∫nico
                    },
                    options: {
                        indexAxis: 'y', responsive: true, maintainAspectRatio: false,
                        layout: { padding: { left: 40 } },
                        plugins: { legend: { display: false }, tooltip: { enabled: false } },
                        scales: {
                            x: { min: 0, max: 24, ticks: { color: '#9CA3AF', stepSize: 2, callback: (v) => `${v}h` }, grid: { color: 'rgba(107, 114, 128, 0.3)' } },
                            y: { 
                                ticks: { display: false }, 
                                grid: { display: false },
                            }
                        }
                    },
                    plugins: [customLabelsPlugin]
                });
            }
            
            function populateTimezoneSelect() {
                const timezoneSelect = document.getElementById('timezone-select');
                if(!timezoneSelect) return;
                timezoneSelect.innerHTML = '';
                markets.forEach(market => {
                    const option = document.createElement('option');
                    option.value = market.timeZone;
                    option.textContent = `${market.flag} ${market.name} (${getUtcOffset(market.timeZone)})`;
                    if (market.id === 'b3') option.selected = true;
                    timezoneSelect.appendChild(option);
                });
            }

            function convertTime() {
                const timeInput = document.getElementById('time-input');
                const timezoneSelect = document.getElementById('timezone-select');
                const convertedTimesDiv = document.getElementById('converted-times');
                if (!timeInput || !timezoneSelect || !convertedTimesDiv) return;

                const inputTime = timeInput.value;
                const inputTimeZone = timezoneSelect.value;
                convertedTimesDiv.innerHTML = '';

                if (!inputTime) {
                    convertedTimesDiv.textContent = 'Insira um hor√°rio.';
                    return;
                }
                
                const nowInSourceTz = new Date(new Date().toLocaleString('en-US', { timeZone: inputTimeZone }));
                const [h, m] = inputTime.split(':').map(Number);
                nowInSourceTz.setHours(h, m, 0, 0);

                markets.forEach(market => {
                    if (market.timeZone === inputTimeZone) return;

                     const targetTime = new Intl.DateTimeFormat('pt-BR', {
                        timeZone: market.timeZone,
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: false
                    }).format(nowInSourceTz);

                    const targetDate = new Date(nowInSourceTz.toLocaleString('en-US', {timeZone: market.timeZone}));
                    
                    let dayIndicator = '';
                    const sourceDay = Math.floor((nowInSourceTz.getTime() - new Date(nowInSourceTz.getFullYear(), 0, 0).getTime()) / (1000 * 60 * 60 * 24));
                    const targetDay = Math.floor((targetDate.getTime() - new Date(targetDate.getFullYear(), 0, 0).getTime()) / (1000 * 60 * 60 * 24));
                    
                    if (targetDay > sourceDay || (targetDate.getFullYear() > nowInSourceTz.getFullYear())) dayIndicator = ' (+1 dia)';
                    if (targetDay < sourceDay || (targetDate.getFullYear() < nowInSourceTz.getFullYear())) dayIndicator = ' (-1 dia)';


                    convertedTimesDiv.innerHTML += `
                        <p class="flex justify-between items-center bg-gray-700 p-2 rounded-lg">
                            <span>${market.flag} ${market.name} <span class="text-xs text-gray-400 ml-1">${getUtcOffset(market.timeZone)}</span></span>
                            <span class="font-semibold text-white">${targetTime}${dayIndicator}</span>
                        </p>`;
                });
            }


            async function fetchCurrencyRates() {
                try {
                    const response = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
                    if (!response.ok) throw new Error('API failed');
                    const data = await response.json();
                    
                    currencyRates = {
                        'USD': 1, 'BRL': data.rates.BRL || 5.00, 'EUR': data.rates.EUR || 0.92,
                        'GBP': data.rates.GBP || 0.79, 'CHF': data.rates.CHF || 0.90
                    };
                } catch (error) {
                    console.error('Erro ao buscar taxas, usando mock data:', error);
                    currencyRates = { 'USD': 1, 'BRL': 5.00, 'EUR': 0.92, 'GBP': 0.79, 'CHF': 0.90 };
                }
                renderCurrencyConverter();
            }

            function renderCurrencyConverter() {
                const currencyListDiv = document.getElementById('currency-list');
                if(!currencyListDiv || Object.keys(currencyRates).length === 0) return;

                currencyListDiv.innerHTML = '';
                currencies.forEach(currency => {
                    const currencyDiv = document.createElement('div');
                    currencyDiv.className = 'flex items-center space-x-2 bg-gray-700 p-2 rounded-lg';
                    currencyDiv.innerHTML = `
                        <span class="text-xl">${currency.flag}</span>
                        <span class="font-medium w-16">${currency.code}</span>
                        <input type="number" step="0.01" value="0.00" data-currency="${currency.code}"
                            class="no-spinner bg-gray-600 text-white rounded-lg p-2 flex-grow text-right focus:outline-none focus:ring-2 focus:ring-blue-500">
                    `;
                    currencyListDiv.appendChild(currencyDiv);
                });

                currencyListDiv.querySelectorAll('input').forEach(input => input.addEventListener('input', handleCurrencyInput));
                
                const brlInput = currencyListDiv.querySelector('input[data-currency="BRL"]');
                if (brlInput && brlInput.value === '0.00') {
                    brlInput.value = '1.00';
                    handleCurrencyInput({ target: brlInput });
                }
            }

            function handleCurrencyInput({ target }) {
                const value = parseFloat(target.value);
                const changedCurrency = target.dataset.currency;

                if (isNaN(value) || !currencyRates[changedCurrency]) return;

                const valueInUSD = value / currencyRates[changedCurrency];
                document.querySelectorAll('#currency-list input').forEach(input => {
                    if (input !== target) {
                        input.value = (valueInUSD * currencyRates[input.dataset.currency]).toFixed(2);
                    }
                });
            }

            function renderAlertSettings() {
                const sessionAlertsDiv = document.getElementById('session-alerts');
                if(!sessionAlertsDiv) return;

                sessionAlertsDiv.innerHTML = '';
                markets.forEach(market => { 
                    const isEnabled = alertSettings[market.id];
                    sessionAlertsDiv.innerHTML += `
                        <label class="flex items-center justify-between p-2 bg-gray-700 rounded-lg cursor-pointer">
                            <span class="text-white">${market.flag} ${market.name} - Abertura</span>
                            <input type="checkbox" data-market-id="${market.id}" ${isEnabled ? 'checked' : ''} class="toggle-checkbox form-checkbox h-5 w-5 text-blue-500 rounded focus:ring-blue-500">
                        </label>`;
                });

                sessionAlertsDiv.querySelectorAll('.toggle-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', (event) => {
                        const marketId = event.target.dataset.marketId;
                        alertSettings[marketId] = event.target.checked;
                        saveAlertSettings();
                        showToast(`Alerta para ${markets.find(m => m.id === marketId).name} ${event.target.checked ? 'ativado' : 'desativado'}`, 'üîî');
                    });
                });
            }

            function renderEconomicEvents() {
                const economicEventsDiv = document.getElementById('economic-events');
                if(!economicEventsDiv) return;
                economicEventsDiv.innerHTML = '';
                if (economicEventsMock.length === 0) {
                    economicEventsDiv.innerHTML = '<p class="text-gray-500">Nenhum evento de alta volatilidade pr√≥ximo.</p>';
                } else {
                    economicEventsMock.forEach(event => {
                        economicEventsDiv.innerHTML += `
                            <div class="flex justify-between items-center p-2 bg-gray-700 rounded-lg">
                                <span class="text-gray-300">${event.time} - ${event.event}</span>
                                <span class="text-yellow-400">${'‚≠ê'.repeat(event.impact)}</span>
                            </div>`;
                    });
                }
            }
            
            function checkSessionAlerts() {
                // L√≥gica de alerta pode ser refinada com os novos tempos
            }

            let toastTimeout;
            function showToast(message, icon = 'üîî', duration = 3000) {
                const toast = document.getElementById('toast');
                if(!toast) return;
                toast.querySelector('#toast-message').textContent = message;
                toast.querySelector('#toast-icon').textContent = icon;
                toast.classList.remove('translate-x-[150%]');
                toast.classList.add('translate-x-0');
                clearTimeout(toastTimeout);
                toastTimeout = setTimeout(() => {
                    toast.classList.remove('translate-x-0');
                    toast.classList.add('translate-x-[150%]');
                }, duration);
            }

            function playSound() {
                if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const o = audioContext.createOscillator();
                const g = audioContext.createGain();
                o.connect(g);
                g.connect(audioContext.destination);
                o.start(0);
                g.gain.exponentialRampToValueAtTime(0.00001, audioContext.currentTime + 0.5);
            }

            function saveAlertSettings() {
                localStorage.setItem('kairosAlertSettings', JSON.stringify(alertSettings));
            }
            function loadAlertSettings() {
                const savedSettings = localStorage.getItem('kairosAlertSettings');
                if (savedSettings) alertSettings = JSON.parse(savedSettings);
            }

            function init() {
                loadAlertSettings();
                populateTimezoneSelect();
                
                const timeInput = document.getElementById('time-input');
                if(timeInput && !timeInput.value) {
                    timeInput.value = formatTime(new Date());
                }
                convertTime(); 
                fetchCurrencyRates(); 
                renderAlertSettings(); 
                renderEconomicEvents();
                
                renderClocks();
                renderSessions();
                renderSessionsChart();

                setInterval(() => {
                    renderClocks();
                    renderSessions();
                }, 1000);
                
                setInterval(renderSessionsChart, 10000);
                setInterval(fetchCurrencyRates, 60000);
                
                document.getElementById('time-input')?.addEventListener('change', convertTime);
                document.getElementById('timezone-select')?.addEventListener('change', convertTime);
            }

            init();
        });
    </script>
</body>
</html>

