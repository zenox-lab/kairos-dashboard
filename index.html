<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KAIROS Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&family=Cormorant+Garamond:wght@600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        .font-brand {
            font-family: 'Cormorant Garamond', serif;
        }
        body {
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }
        .no-spinner::-webkit-outer-spin-button,
        .no-spinner::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .no-spinner { -moz-appearance: textfield; }
        .chart-container {
            position: relative; 
            width: 100%; 
            max-width: 600px; 
            margin-left: auto; 
            margin-right: auto;
            height: 150px;
            max-height: 200px;
        }
        .toggle-checkbox:checked { right: 0; border-color: #4F46E5; }
        .toggle-checkbox:checked + .toggle-label { background-color: #4F46E5; }
        
        .kairos-frame {
            border: 1px solid;
            border-image-slice: 1;
            border-width: 1px;
            border-image-source: linear-gradient(to bottom right, #4A5568, #A0AEC0);
            padding: 2px 10px;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-300">

    <div id="app" class="max-w-md mx-auto bg-black min-h-screen">
        
        <header class="sticky top-0 bg-black bg-opacity-80 backdrop-blur-md z-10 p-4 pt-6 flex justify-between items-center">
            <div class="kairos-frame">
                 <h1 class="text-2xl font-brand font-semibold text-gray-200 tracking-widest">KAIROS</h1>
            </div>
            <button id="mode-toggle" class="text-sm bg-gray-800 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-full transition-all duration-300">
                <span id="mode-toggle-icon" class="text-indigo-400">⚫</span> <span id="mode-toggle-text">Detalhado</span>
            </button>
        </header>

        <main class="p-4 space-y-8">
            
            <section id="clocks">
                <h2 class="text-lg font-semibold mb-4 text-indigo-300">Relógios Globais</h2>
                <div class="grid grid-cols-2 gap-4">
                    <!-- Clocks will be injected here -->
                </div>
            </section>

            <section id="sessions">
                <h2 class="text-lg font-semibold mb-4 text-indigo-300">Sessões de Mercado</h2>
                 <p class="text-sm text-gray-400 mb-4">Acompanhe o status de abertura dos principais mercados globais, com horários e contadores ajustados para o fuso de Brasília (BRT).</p>
                <div class="space-y-4">
                     <!-- Sessions will be injected here -->
                </div>
                 <div class="mt-6 bg-gray-900 border border-gray-800 p-4 rounded-xl">
                     <h3 class="text-md font-medium text-center text-gray-400 mb-2">Sobreposição de Sessões (BRT)</h3>
                     <div class="chart-container">
                        <canvas id="sessionsChart"></canvas>
                    </div>
                 </div>
            </section>

            <div id="detailed-sections" class="space-y-8 transition-all duration-500">
                <section id="time-converter">
                    <h2 class="text-lg font-semibold mb-4 text-indigo-300">Conversor de Horário</h2>
                    <p class="text-sm text-gray-400 mb-4">Insira um horário em qualquer mercado para ver a correspondência nos outros centros financeiros instantaneamente.</p>
                    <div class="bg-gray-900 border border-gray-800 p-4 rounded-xl space-y-4">
                        <div class="flex items-center space-x-3">
                            <input type="time" id="time-input" class="bg-gray-800 text-white rounded-lg p-2 w-full focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <select id="timezone-select" class="bg-gray-800 text-white rounded-lg p-2 w-full focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            </select>
                        </div>
                        <div id="converted-times" class="text-center text-gray-300 space-y-2 pt-2">
                        </div>
                    </div>
                </section>

                <section id="currency-converter">
                    <h2 class="text-lg font-semibold mb-4 text-indigo-300">Conversor Cambial</h2>
                    <p class="text-sm text-gray-400 mb-4">Cotações em tempo real. Digite um valor em qualquer moeda para converter para as demais.</p>
                    <div id="currency-list" class="bg-gray-900 border border-gray-800 p-4 rounded-xl space-y-4">
                    </div>
                </section>

                <section id="alerts">
                    <h2 class="text-lg font-semibold mb-4 text-indigo-300">Alertas Inteligentes</h2>
                    <p class="text-sm text-gray-400 mb-4">Configure notificações para aberturas de sessão e eventos económicos de alta volatilidade.</p>
                    <div class="bg-gray-900 border border-gray-800 p-4 rounded-xl space-y-4">
                        <div>
                            <h3 class="font-medium text-white mb-3">Alertas de Sessão</h3>
                            <div id="session-alerts" class="space-y-3">
                            </div>
                        </div>
                         <div class="border-t border-gray-800 my-4"></div>
                         <div>
                            <h3 class="font-medium text-white mb-3">Próximos Eventos de Volatilidade</h3>
                            <div id="economic-events" class="space-y-2 text-sm">
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-10 right-1/2 translate-x-1/2 w-11/12 max-w-sm flex items-center bg-indigo-600 text-white py-3 px-5 rounded-lg shadow-2xl transform translate-y-[200%] transition-transform duration-500 ease-in-out">
        <span id="toast-icon" class="mr-3 text-xl"></span>
        <span id="toast-message"></span>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- CONFIGURAÇÃO ---
            const markets = [
                { id: 'ny', name: 'Nova York', flag: 'https://flagcdn.com/w40/us.png', timeZone: 'America/New_York', open: '09:30', close: '16:00' },
                { id: 'frankfurt', name: 'Frankfurt', flag: 'https://flagcdn.com/w40/eu.png', timeZone: 'Europe/Berlin', open: '09:00', close: '17:30' },
                { id: 'london', name: 'Londres', flag: 'https://flagcdn.com/w40/gb.png', timeZone: 'Europe/London', open: '08:00', close: '16:30' },
                { id: 'tokyo', name: 'Tóquio', flag: 'https://flagcdn.com/w40/jp.png', timeZone: 'Asia/Tokyo', open: '09:00', close: '15:00' },
                { id: 'brasilia', name: 'Brasília', flag: 'https://flagcdn.com/w40/br.png', timeZone: 'America/Sao_Paulo', open: '10:00', close: '18:00' }
            ];
            const currencies = [
                { code: 'BRL', name: 'Real', flag: 'https://flagcdn.com/w40/br.png' },
                { code: 'USD', name: 'Dólar', flag: 'https://flagcdn.com/w40/us.png' },
                { code: 'EUR', name: 'Euro', flag: 'https://flagcdn.com/w40/eu.png' },
                { code: 'GBP', name: 'Libra', flag: 'https://flagcdn.com/w40/gb.png' },
                { code: 'CHF', name: 'Franco', flag: 'https://flagcdn.com/w40/ch.png' }
            ];
            const economicEventsMock = [
                { time: '10:30', event: 'CPI (EUA)', impact: 3 },
                { time: '15:00', event: 'Discurso do Fed', impact: 3 },
                { time: 'Amanhã 09:30', event: 'Payroll (EUA)', impact: 3 },
            ];

            // --- ESTADO DA APLICAÇÃO ---
            let currencyRates = {};
            let isDetailedMode = true;
            let alertSettings = { tokyo: true, london: true, ny: true };
            const triggeredAlerts = new Set();
            let audioContext;

            // --- DECLARAÇÃO DE FUNÇÕES ---

            function initAudio() {
                if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }

            function playSound() {
                if (!audioContext) return;
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(880, audioContext.currentTime);
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.00001, audioContext.currentTime + 0.5);
                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.5);
            }

            function showToast(message, icon) {
                const toast = document.getElementById('toast');
                document.getElementById('toast-message').textContent = message;
                document.getElementById('toast-icon').textContent = icon;
                toast.classList.remove('translate-y-[200%]');
                toast.classList.add('translate-y-0');
                playSound();
                setTimeout(() => {
                    toast.classList.remove('translate-y-0');
                    toast.classList.add('translate-y-[200%]');
                }, 4000);
            }

            function formatTime(date, timeZone) {
                return date.toLocaleTimeString('pt-BR', { timeZone, hour: '2-digit', minute: '2-digit' });
            }

            function createClock(market) {
                const now = new Date();
                return `
                    <div class="bg-gray-900 border border-gray-800 p-4 rounded-xl flex flex-col text-center items-center">
                        <div class="flex items-center mb-2">
                             <img src="${market.flag}" alt="${market.name}" class="w-5 h-5 rounded-full object-cover mr-2">
                             <span class="font-semibold text-white">${market.name}</span>
                        </div>
                        <div id="clock-${market.id}" class="text-4xl font-light font-mono text-gray-200">${formatTime(now, market.timeZone)}</div>
                    </div>
                `;
            }

            function createSession(market) {
                return `
                    <div id="session-card-${market.id}" class="bg-gray-900 border border-gray-800 p-4 rounded-xl shadow-md">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center">
                                <span id="status-indicator-${market.id}" class="w-3 h-3 rounded-full mr-3 transition-colors"></span>
                                <img src="${market.flag}" alt="${market.name}" class="w-6 h-6 rounded-full object-cover mr-3 shadow-sm">
                                <span class="font-bold text-white">${market.name}</span>
                            </div>
                            <span id="status-text-${market.id}" class="text-sm font-semibold transition-colors"></span>
                        </div>
                        <div class="text-xs text-gray-400 mt-2">
                            Abertura: <span id="open-time-${market.id}">--:--</span> | Fechamento: <span id="close-time-${market.id}">--:--</span> (BRT)
                        </div>
                        <div id="countdown-${market.id}" class="text-center text-sm mt-3 text-indigo-300"></div>
                    </div>
                `;
            }
            
            function createCurrencyInput(currency) {
                return `
                    <div class="flex items-center space-x-3">
                        <img src="${currency.flag}" alt="${currency.code}" class="w-8 h-8 rounded-full object-cover shadow-sm">
                        <label for="currency-${currency.code}" class="w-20 text-sm font-medium text-gray-300">${currency.code}</label>
                        <input type="number" id="currency-${currency.code}" data-code="${currency.code}"
                               class="no-spinner text-right bg-gray-800 text-white w-full p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                               placeholder="0.00">
                    </div>
                `;
            }
            
            function createSessionAlertToggle(market) {
                return `
                     <div class="flex justify-between items-center">
                        <div class="flex items-center">
                            <img src="${market.flag}" alt="${market.name}" class="w-6 h-6 rounded-full object-cover mr-3">
                            <label for="alert-toggle-${market.id}" class="text-sm text-gray-300">${market.name}</label>
                        </div>
                        <div class="relative inline-block w-10 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" name="toggle" id="alert-toggle-${market.id}" data-market="${market.id}"
                                   class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"
                                   ${alertSettings[market.id] ? 'checked' : ''}/>
                            <label for="alert-toggle-${market.id}"
                                   class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-600 cursor-pointer"></label>
                        </div>
                    </div>
                `;
            }

            function updateClocks() {
                const now = new Date();
                markets.forEach(market => {
                    const el = document.getElementById(`clock-${market.id}`);
                    if (el) el.textContent = formatTime(now, market.timeZone);
                });
            }
            
            function getMarketStatus(market) {
                const now = new Date();
                const options = { timeZone: market.timeZone, hour12: false };
                const timeInMarketTZStr = now.toLocaleString('en-US', options);
                const timeInMarketTZ = new Date(timeInMarketTZStr);

                const openTime = new Date(timeInMarketTZ);
                openTime.setHours(...market.open.split(':'), 0, 0);

                const closeTime = new Date(timeInMarketTZ);
                closeTime.setHours(...market.close.split(':'), 0, 0);
                
                const day = timeInMarketTZ.getDay();
                const isWeekend = (market.id !== 'tokyo' && (day === 0 || day === 6));
                
                const isOpen = !isWeekend && timeInMarketTZ >= openTime && timeInMarketTZ < closeTime;
                
                let nextEventTime = isOpen ? closeTime : openTime;
                if (!isOpen && timeInMarketTZ >= closeTime) {
                    nextEventTime.setDate(nextEventTime.getDate() + 1);
                }

                const nextDay = nextEventTime.getDay();
                if (nextDay === 6) nextEventTime.setDate(nextEventTime.getDate() + 2); // Sábado -> Segunda
                if (nextDay === 0) nextEventTime.setDate(nextEventTime.getDate() + 1); // Domingo -> Segunda

                return {
                    isOpen,
                    countdownSeconds: Math.floor((nextEventTime - timeInMarketTZ) / 1000),
                    eventType: isOpen ? 'Fecha' : 'Abre',
                    openTimeLocal: formatTime(openTime, 'America/Sao_Paulo'),
                    closeTimeLocal: formatTime(closeTime, 'America/Sao_Paulo')
                };
            }

            function updateSessions() {
                ['tokyo', 'london', 'ny'].forEach(id => {
                    const market = markets.find(m => m.id === id);
                    const status = getMarketStatus(market);
                    
                    const indicator = document.getElementById(`status-indicator-${id}`);
                    const statusText = document.getElementById(`status-text-${id}`);
                    const countdownEl = document.getElementById(`countdown-${id}`);
                    
                    document.getElementById(`open-time-${id}`).textContent = status.openTimeLocal;
                    document.getElementById(`close-time-${id}`).textContent = status.closeTimeLocal;

                    indicator.className = `w-3 h-3 rounded-full mr-3 transition-colors ${status.isOpen ? 'bg-green-500' : 'bg-gray-500'}`;
                    statusText.textContent = status.isOpen ? 'Aberta' : 'Fechada';
                    statusText.className = `text-sm font-semibold transition-colors ${status.isOpen ? 'text-green-400' : 'text-gray-400'}`;

                    if (status.countdownSeconds > 0) {
                        const h = Math.floor(status.countdownSeconds / 3600).toString().padStart(2, '0');
                        const m = Math.floor((status.countdownSeconds % 3600) / 60).toString().padStart(2, '0');
                        const s = (status.countdownSeconds % 60).toString().padStart(2, '0');
                        countdownEl.textContent = `${status.eventType} em ${h}:${m}:${s}`;
                    } else {
                        countdownEl.textContent = 'Atualizando...';
                    }

                    if (alertSettings[id]) {
                        const preOpenKey = `${id}-pre`;
                        if (status.eventType === 'Abre' && status.countdownSeconds <= 900 && status.countdownSeconds > 899 && !triggeredAlerts.has(preOpenKey)) {
                           showToast(`${market.name} abre em 15 minutos!`, '⏰');
                           triggeredAlerts.add(preOpenKey);
                        }
                    }
                });
            }

            function updateTimeConverter() {
                const timeInput = document.getElementById('time-input').value;
                const sourceTz = document.getElementById('timezone-select').value;
                const outputEl = document.getElementById('converted-times');

                if (!timeInput) {
                    outputEl.innerHTML = '';
                    return;
                }

                const [hours, minutes] = timeInput.split(':');
                
                outputEl.innerHTML = '';
                markets.filter(m => m.timeZone !== sourceTz).forEach(market => {
                     try {
                        const tempDate = new Date();
                        tempDate.setHours(hours, minutes, 0, 0);
                        const convertedTime = formatTime(tempDate, market.timeZone);
                        outputEl.innerHTML += `<p><img src="${market.flag}" class="w-5 h-5 inline mr-2 rounded-full"/> ${market.name}: <span class="font-bold text-white">${convertedTime}</span></p>`;
                    } catch(e) { console.error("Time conversion error", e); }
                });
            }

            async function fetchCurrencyRates() {
                try {
                    const response = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
                    if (!response.ok) throw new Error('API indisponível');
                    const data = await response.json();
                    if (data && data.rates) currencyRates = { ...data.rates, USD: 1 };
                    else throw new Error("Estrutura de dados inválida");
                } catch (error) {
                    console.error("Erro ao buscar cotações:", error);
                    showToast("Erro ao buscar cotações.", "⚠️");
                    if (Object.keys(currencyRates).length === 0) {
                         currencyRates = { USD: 1, BRL: 5.0, EUR: 0.92, GBP: 0.79, CHF: 0.90 };
                    }
                }
            }
            
            function updateCurrency(sourceInput) {
                const sourceCode = sourceInput.dataset.code;
                const sourceValue = parseFloat(sourceInput.value);

                if (isNaN(sourceValue) || sourceValue === 0 || sourceInput.value === '') {
                    currencies.forEach(c => { if(c.code !== sourceCode) document.getElementById(`currency-${c.code}`).value = ''; });
                    return;
                }

                if (!currencyRates[sourceCode]) return;
                const valueInUSD = sourceValue / currencyRates[sourceCode];

                currencies.forEach(c => {
                    if (c.code !== sourceCode && currencyRates[c.code]) {
                        document.getElementById(`currency-${c.code}`).value = (valueInUSD * currencyRates[c.code]).toFixed(4);
                    }
                });
            }

            function toggleMode() {
                isDetailedMode = !isDetailedMode;
                const detailedSections = document.getElementById('detailed-sections');
                detailedSections.style.maxHeight = isDetailedMode ? `${detailedSections.scrollHeight}px` : '0px';
                detailedSections.style.opacity = isDetailedMode ? '1' : '0';
                document.getElementById('mode-toggle-text').textContent = isDetailedMode ? 'Detalhado' : 'Compacto';
                document.getElementById('mode-toggle-icon').textContent = isDetailedMode ? '⚫' : '⚪';
            }
            
            function renderSessionChart() {
                const ctx = document.getElementById('sessionsChart').getContext('2d');
                const datasets = [
                    { name: 'Tóquio', open: 21, close: 6, color: '#EF4444' }, // red-500
                    { name: 'Londres', open: 4, close: 12, color: '#3B82F6' }, // blue-500
                    { name: 'NY', open: 9, close: 17, color: '#22C55E' }  // green-500
                ].map(session => ({
                    label: session.name,
                    data: Array.from({ length: 24 }, (_, i) => (session.open < session.close ? (i >= session.open && i < session.close) : (i >= session.open || i < session.close)) ? 1 : 0),
                    borderColor: session.color,
                    backgroundColor: `${session.color}66`,
                    stepped: true, pointRadius: 0, borderWidth: 2,
                }));
                
                new Chart(ctx, {
                    type: 'line',
                    data: { labels: Array.from({ length: 24 }, (_, i) => `${i}h`), datasets },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        scales: {
                            y: { display: false, max: 1.5 },
                            x: { ticks: { color: '#6B7280', maxRotation: 0, autoSkip: true, maxTicksLimit: 6 }, grid: { color: '#1F2937' } }
                        },
                        plugins: { legend: { labels: { color: '#D1D5DB' } } }
                    }
                });
            }

            // --- INICIALIZAÇÃO ---
            function init() {
                document.body.addEventListener('click', initAudio, { once: true });
                document.body.addEventListener('touchstart', initAudio, { once: true });
                document.querySelector('#clocks .grid').innerHTML = markets.map(createClock).join('');
                document.querySelector('#sessions .space-y-4').innerHTML = ['tokyo', 'london', 'ny'].map(id => createSession(markets.find(m => m.id === id))).join('');
                document.getElementById('timezone-select').innerHTML = markets.map(m => `<option value="${m.timeZone}">${m.name}</option>`).join('');
                document.getElementById('currency-list').innerHTML = currencies.map(createCurrencyInput).join('');
                document.getElementById('session-alerts').innerHTML = ['tokyo', 'london', 'ny'].map(id => createSessionAlertToggle(markets.find(m => m.id === id))).join('');
                document.getElementById('economic-events').innerHTML = economicEventsMock.map(e => `
                    <div class="flex justify-between items-center bg-gray-800 p-2 rounded-lg">
                        <span>${e.time} - ${e.event}</span>
                        <span class="text-red-400 font-bold">${'🐂'.repeat(e.impact)}</span>
                    </div>
                `).join('');

                document.getElementById('mode-toggle').addEventListener('click', toggleMode);
                document.getElementById('time-input').addEventListener('input', updateTimeConverter);
                document.getElementById('timezone-select').addEventListener('change', updateTimeConverter);
                document.getElementById('currency-list').addEventListener('input', e => { if (e.target.tagName === 'INPUT') updateCurrency(e.target); });
                document.getElementById('session-alerts').addEventListener('change', e => { if (e.target.classList.contains('toggle-checkbox')) alertSettings[e.target.dataset.market] = e.target.checked; });
                
                fetchCurrencyRates().then(() => setInterval(fetchCurrencyRates, 60000));
                
                setInterval(() => { updateClocks(); updateSessions(); }, 1000);
                
                renderSessionChart();
                
                const defaultTimeInput = document.getElementById('time-input');
                const now = new Date();
                defaultTimeInput.value = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;

                setTimeout(() => {
                    const detailedSections = document.getElementById('detailed-sections');
                    detailedSections.style.maxHeight = detailedSections.scrollHeight + 'px';
                    updateTimeConverter();
                }, 100);
            }

            init();
        });
    </script>
</body>
</html>

