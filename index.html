<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-g">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- Chosen Palette: Dark Professional (Matte Black, Gray, Accent Blue) -->
    <!-- Application Structure Plan: A mobile-first, single-column dashboard layout. The structure prioritizes at-a-glance information with Global Clocks and Market Sessions at the top, followed by interactive tools (Time & Currency Converters) and settings (Alerts). A sticky header with a compact/detailed mode toggle allows users to customize information density instantly. This card-based widget design is intuitive for mobile users and makes complex trading information easily digestible. The flow is designed for quick checks and deeper interaction without leaving the main screen. -->
    <!-- Visualization & Content Choices: 
        - Global Clocks: Goal=Inform. Method=Digital clock cards. Interaction=None. Justification=Provides critical, real-time market times immediately. Library=Vanilla JS.
        - Market Sessions: Goal=Inform/Compare. Method=Status cards with color codes, countdowns, and a simple chart. Interaction=None. Justification=Visual indicators for session status are quick to parse. Chart.js visualizes overlaps for liquidity insights. Library=Vanilla JS, Chart.js.
        - Time Converter: Goal=Organize. Method=Input form. Interaction=User input triggers automatic conversion display. Justification=Intuitive tool for planning trades across timezones. Library=Vanilla JS.
        - Currency Converter: Goal=Inform. Method=Interactive input fields. Interaction=Typing in one field updates all others. Justification=Fast and efficient for checking cross-rates. Library=Vanilla JS (Fetch API).
        - Alerts: Goal=Inform. Method=List of events and toggle switches. Interaction=User toggles settings. Justification=Gives users control over notifications, simulated with a custom toast element. Library=Vanilla JS.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <title>KAIROS Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

        /* For iPhone 12 Pro Max safe areas */
        body {
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }
        .no-spinner::-webkit-outer-spin-button,
        .no-spinner::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .no-spinner {
            -moz-appearance: textfield;
        }
        .chart-container {
            position: relative; 
            width: 100%; 
            max-width: 600px; 
            margin-left: auto; 
            margin-right: auto;
            height: 150px;
            max-height: 200px;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <div id="app" class="max-w-md mx-auto bg-gray-900 min-h-screen">
        
        <header class="sticky top-0 bg-gray-900 bg-opacity-80 backdrop-blur-md z-10 p-4 pt-6 flex justify-between items-center">
            <h1 class="text-xl font-bold text-white">KAIROS</h1>
            <button id="mode-toggle" class="text-sm bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-full transition-all duration-300">
                <span id="mode-toggle-icon">👁️</span> <span id="mode-toggle-text">Detalhado</span>
            </button>
        </header>

        <main class="p-4 space-y-6">
            
            <section id="clocks">
                <h2 class="text-lg font-semibold mb-3 text-blue-300">Relógios Globais</h2>
                <div class="grid grid-cols-2 sm:grid-cols-3 gap-4">
                    <!-- Clocks will be injected here -->
                </div>
            </section>

            <section id="sessions">
                <h2 class="text-lg font-semibold mb-3 text-blue-300">Sessões de Mercado</h2>
                 <p class="text-sm text-gray-400 mb-4">Acompanhe o estado de abertura dos principais mercados globais, com horários e contadores ajustados para o fuso de Brasília (BRT).</p>
                <div class="space-y-4">
                     <!-- Sessions will be injected here -->
                </div>
                 <div class="mt-4 bg-gray-800 p-4 rounded-xl">
                     <h3 class="text-md font-medium text-center text-gray-300 mb-2">Sobreposição de Sessões (BRT)</h3>
                     <div class="chart-container">
                        <canvas id="sessionsChart"></canvas>
                    </div>
                 </div>
            </section>

            <div id="detailed-sections" class="space-y-6 transition-all duration-500">
                <section id="time-converter">
                    <h2 class="text-lg font-semibold mb-3 text-blue-300">Conversor de Horário</h2>
                    <p class="text-sm text-gray-400 mb-4">Insira um horário em qualquer mercado para ver a correspondência nos outros centros financeiros instantaneamente.</p>
                    <div class="bg-gray-800 p-4 rounded-xl space-y-4">
                        <div class="flex items-center space-x-2">
                            <input type="time" id="time-input" class="bg-gray-700 text-white rounded-lg p-2 w-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <select id="timezone-select" class="bg-gray-700 text-white rounded-lg p-2 w-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <!-- Options will be injected here -->
                            </select>
                        </div>
                        <div id="converted-times" class="text-center text-gray-300 space-y-1">
                            <!-- Converted times will appear here -->
                        </div>
                    </div>
                </section>

                <section id="currency-converter">
                    <h2 class="text-lg font-semibold mb-3 text-blue-300">Conversor Cambial</h2>
                    <p class="text-sm text-gray-400 mb-4">Cotações em tempo real. Digite um valor em qualquer moeda para converter para as demais. As taxas são atualizadas a cada minuto.</p>
                    <div id="currency-list" class="bg-gray-800 p-4 rounded-xl space-y-3">
                        <!-- Currencies will be injected here -->
                    </div>
                </section>

                <section id="alerts">
                    <h2 class="text-lg font-semibold mb-3 text-blue-300">Alertas Inteligentes</h2>
                    <p class="text-sm text-gray-400 mb-4">Configure notificações para aberturas de sessão e eventos económicos de alta volatilidade para nunca perder uma oportunidade.</p>
                    <div class="bg-gray-800 p-4 rounded-xl space-y-4">
                        <div>
                            <h3 class="font-medium text-white mb-2">Alertas de Sessão</h3>
                            <div id="session-alerts" class="space-y-2">
                                <!-- Session alerts toggles will be injected here -->
                            </div>
                        </div>
                         <div>
                            <h3 class="font-medium text-white mb-2">Próximos Eventos de Volatilidade</h3>
                            <div id="economic-events" class="space-y-2 text-sm">
                                <!-- Mock economic events will be injected here -->
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-10 right-10 flex items-center bg-blue-500 text-white py-3 px-5 rounded-lg shadow-lg transform translate-x-[150%] transition-transform duration-500 ease-in-out">
        <span id="toast-icon" class="mr-3 text-xl">🔔</span>
        <span id="toast-message"></span>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const markets = [
                { id: 'ny', name: 'Nova Iorque', flag: '🇺🇸', timeZone: 'America/New_York', open: '09:30', close: '16:00' },
                { id: 'frankfurt', name: 'Frankfurt', flag: '🇪🇺', timeZone: 'Europe/Berlin', open: '09:00', close: '17:30' },
                { id: 'london', name: 'Londres', flag: '🇬🇧', timeZone: 'Europe/London', open: '08:00', close: '16:30' },
                { id: 'tokyo', name: 'Tóquio', flag: '🇯🇵', timeZone: 'Asia/Tokyo', open: '09:00', close: '15:00' },
                { id: 'brasilia', name: 'Brasília', flag: '🇧🇷', timeZone: 'America/Sao_Paulo', open: '10:00', close: '18:00' }
            ];

            const currencies = [
                { code: 'BRL', name: 'Real', flag: '🇧🇷' },
                { code: 'USD', name: 'Dólar', flag: '🇺🇸' },
                { code: 'EUR', name: 'Euro', flag: '🇪🇺' },
                { code: 'GBP', name: 'Libra', flag: '🇬🇧' },
                { code: 'CHF', name: 'Franco', flag: '🇨🇭' }
            ];

            const economicEventsMock = [
                { time: '10:30', event: 'CPI (EUA)', impact: 3 },
                { time: '15:00', event: 'Discurso da Fed', impact: 3 },
                { time: 'Amanhã 09:30', event: 'Payroll (EUA)', impact: 3 },
            ];

            let currencyRates = {};
            let isDetailedMode = true;
            let alertSettings = {
                tokyo: true,
                london: true,
                ny: true
            };
            const triggeredAlerts = new Set();
            let audioContext;

            function initAudio() {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
            }
            document.body.addEventListener('click', initAudio, { once: true });
            document.body.addEventListener('touchstart', initAudio, { once: true });

            function playSound() {
                if (!audioContext) return;
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(880, audioContext.currentTime);
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.00001, audioContext.currentTime + 0.5);
                
                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.5);
            }

            function showToast(message, icon = '🔔') {
                const toast = document.getElementById('toast');
                document.getElementById('toast-message').textContent = message;
                document.getElementById('toast-icon').textContent = icon;
                toast.classList.remove('translate-x-[150%]');
                toast.classList.add('translate-x-0');

                playSound();

                setTimeout(() => {
                    toast.classList.remove('translate-x-0');
                    toast.classList.add('translate-x-[150%]');
                }, 5000);
            }

            function formatTime(date, timeZone, withSeconds = true) {
                const options = { timeZone, hour: '2-digit', minute: '2-digit' };
                if (withSeconds) {
                    options.second = '2-digit';
                }
                return date.toLocaleTimeString('pt-BR', options);
            }

            function getUtcOffset(timeZone) {
                const now = new Date();
                const offsetMinutes = -now.toLocaleTimeString('en-US', { timeZoneName: 'longOffset', timeZone }).split('GMT')[1] * 60;
                const offsetHours = offsetMinutes / 60;
                return `UTC${offsetHours >= 0 ? '+' : ''}${offsetHours}`;
            }

            function createClock(market) {
                const now = new Date();
                const timeString = formatTime(now, market.timeZone, false);

                return `
                    <div class="bg-gray-800/50 border border-gray-700 p-3 rounded-lg flex flex-col justify-between" style="height: 90px;">
                        <div class="flex items-center">
                            <span class="text-base">${market.flag}</span>
                            <span class="ml-2 text-gray-300 font-medium text-sm">${market.name}</span>
                        </div>
                        <div class="text-right">
                            <div id="clock-${market.id}" class="text-3xl font-light text-gray-100 -mb-1 tracking-wide">
                                ${timeString}
                            </div>
                            <div class="text-xs text-gray-500 font-medium">${getUtcOffset(market.timeZone)}</div>
                        </div>
                    </div>
                `;
            }

            function createSession(market) {
                return `
                    <div id="session-card-${market.id}" class="bg-gray-800 p-4 rounded-xl shadow-md">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center">
                                <span id="status-indicator-${market.id}" class="w-3 h-3 rounded-full mr-3"></span>
                                <span class="font-bold text-white">${market.flag} ${market.name}</span>
                            </div>
                            <span id="status-text-${market.id}" class="text-sm font-semibold"></span>
                        </div>
                        <div class="text-xs text-gray-400 mt-2">
                            Abertura: <span id="open-time-${market.id}">--:--</span> BRT | Fecho: <span id="close-time-${market.id}">--:--</span> BRT
                        </div>
                        <div id="countdown-${market.id}" class="text-center text-sm mt-2 text-blue-300"></div>
                    </div>
                `;
            }

            function createCurrencyInput(currency) {
                return `
                    <div class="flex items-center space-x-3">
                        <label for="currency-${currency.code}" class="w-24 text-sm font-medium text-gray-300">
                            ${currency.flag} ${currency.code}
                        </label>
                        <input type="number" id="currency-${currency.code}" data-code="${currency.code}"
                               class="no-spinner text-right bg-gray-700 text-white w-full p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="0.00">
                    </div>
                `;
            }
            
            function createSessionAlertToggle(market) {
                return `
                     <div class="flex justify-between items-center">
                        <label for="alert-toggle-${market.id}" class="text-sm text-gray-300">${market.flag} ${market.name}</label>
                        <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" name="toggle" id="alert-toggle-${market.id}" data-market="${market.id}"
                                   class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"
                                   ${alertSettings[market.id] ? 'checked' : ''}/>
                            <label for="alert-toggle-${market.id}"
                                   class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-600 cursor-pointer"></label>
                        </div>
                    </div>
                    <style>
                        .toggle-checkbox:checked { right: 0; border-color: #3B82F6; }
                        .toggle-checkbox:checked + .toggle-label { background-color: #3B82F6; }
                    </style>
                `;
            }

            function updateClocks() {
                const now = new Date();
                markets.forEach(market => {
                    const clockEl = document.getElementById(`clock-${market.id}`);
                    if (clockEl) {
                        clockEl.textContent = formatTime(now, market.timeZone, false);
                    }
                });
            }
            
            function getMarketStatus(market) {
                const now = new Date();
                
                const timeInMarketTZ = new Date(now.toLocaleString('en-US', { timeZone: market.timeZone }));
                const marketDay = timeInMarketTZ.getDay();
                
                const openTimeParts = market.open.split(':');
                const closeTimeParts = market.close.split(':');

                const openTime = new Date(timeInMarketTZ);
                openTime.setHours(parseInt(openTimeParts[0]), parseInt(openTimeParts[1]), 0, 0);

                const closeTime = new Date(timeInMarketTZ);
                closeTime.setHours(parseInt(closeTimeParts[0]), parseInt(closeTimeParts[1]), 0, 0);

                const isWeekend = (market.id !== 'tokyo' && (marketDay === 0 || marketDay === 6));
                
                const isOpen = !isWeekend && now > openTime && now < closeTime;
                let nextEventTime, eventType;

                if (isOpen) {
                    nextEventTime = closeTime;
                    eventType = 'Fecho';
                } else {
                    nextEventTime = openTime;
                    eventType = 'Abertura';
                    if (now > openTime) { // Market already closed for the day
                        nextEventTime.setDate(nextEventTime.getDate() + 1);
                    }
                     // Adjust for weekend
                    if (nextEventTime.getDay() === 6) nextEventTime.setDate(nextEventTime.getDate() + 2); // Saturday -> Monday
                    if (nextEventTime.getDay() === 0) nextEventTime.setDate(nextEventTime.getDate() + 1); // Sunday -> Monday
                }

                const diffSeconds = Math.floor((nextEventTime - now) / 1000);
                
                return {
                    isOpen,
                    countdownSeconds: diffSeconds,
                    eventType,
                    openTimeLocal: openTime.toLocaleTimeString('pt-BR', {timeZone: 'America/Sao_Paulo', hour: '2-digit', minute: '2-digit'}),
                    closeTimeLocal: closeTime.toLocaleTimeString('pt-BR', {timeZone: 'America/Sao_Paulo', hour: '2-digit', minute: '2-digit'})
                };
            }

            function updateSessions() {
                ['tokyo', 'london', 'ny'].forEach(marketId => {
                    const market = markets.find(m => m.id === marketId);
                    if (!market) return;
                    
                    const status = getMarketStatus(market);

                    const indicator = document.getElementById(`status-indicator-${market.id}`);
                    const statusText = document.getElementById(`status-text-${market.id}`);
                    const countdownEl = document.getElementById(`countdown-${market.id}`);
                    
                    document.getElementById(`open-time-${market.id}`).textContent = status.openTimeLocal;
                    document.getElementById(`close-time-${market.id}`).textContent = status.closeTimeLocal;

                    if (status.isOpen) {
                        indicator.classList.remove('bg-gray-500');
                        indicator.classList.add('bg-green-500');
                        statusText.textContent = 'Aberta';
                        statusText.classList.remove('text-gray-400');
                        statusText.classList.add('text-green-400');
                    } else {
                        indicator.classList.remove('bg-green-500');
                        indicator.classList.add('bg-gray-500');
                        statusText.textContent = 'Fechada';
                        statusText.classList.remove('text-green-400');
                        statusText.classList.add('text-gray-400');
                    }

                    const hours = Math.floor(status.countdownSeconds / 3600);
                    const minutes = Math.floor((status.countdownSeconds % 3600) / 60);
                    const seconds = status.countdownSeconds % 60;
                    countdownEl.textContent = `${status.eventType} em ${String(hours).padStart(2,'0')}:${String(minutes).padStart(2,'0')}:${String(seconds).padStart(2,'0')}`;

                    // Alert logic
                    const alertKeyOpen = `${market.id}-open-${status.openTimeLocal}`;
                    const alertKeyClose = `${market.id}-close-${status.closeTimeLocal}`;

                    if (alertSettings[market.id]) {
                         // 15 min before open
                        const alertKeyPreOpen = `${market.id}-pre-open-${status.openTimeLocal}`;
                        if (status.eventType === 'Abertura' && status.countdownSeconds > 899 && status.countdownSeconds <= 900 && !triggeredAlerts.has(alertKeyPreOpen)) {
                           showToast(`${market.name} abre em 15 minutos!`, '⏰');
                           triggeredAlerts.add(alertKeyPreOpen);
                        }
                        // On open
                        if (status.isOpen && !triggeredAlerts.has(alertKeyOpen)) {
                            showToast(`${market.name} abriu!`, '🟢');
                            triggeredAlerts.add(alertKeyOpen);
                        }
                        // On close
                        if (!status.isOpen && triggeredAlerts.has(alertKeyOpen) && !triggeredAlerts.has(alertKeyClose)) {
                            showToast(`${market.name} fechou.`, '🔴');
                            triggeredAlerts.add(alertKeyClose);
                        }
                    }
                });
            }

            function updateTimeConverter() {
                const timeInput = document.getElementById('time-input').value;
                const sourceTz = document.getElementById('timezone-select').value;
                if (!timeInput) return;

                const [hours, minutes] = timeInput.split(':');
                const baseDate = new Date();
                
                const tempDateStr = `${baseDate.getFullYear()}-${String(baseDate.getMonth() + 1).padStart(2, '0')}-${String(baseDate.getDate()).padStart(2, '0')}T${hours}:${minutes}:00`;
                
                const outputEl = document.getElementById('converted-times');
                outputEl.innerHTML = '';

                markets.filter(m => m.timeZone !== sourceTz).forEach(market => {
                     try {
                        const sourceDate = new Date(new Date(tempDateStr).toLocaleString("en-US", {timeZone: sourceTz}));
                        const targetDate = new Date(sourceDate.toLocaleString("en-US", { timeZone: market.timeZone }));
                        const timeDiff = (targetDate.getTime() - sourceDate.getTime()) / (1000 * 60 * 60);

                        const finalDate = new Date(tempDateStr);
                        finalDate.setHours(finalDate.getHours() - timeDiff);

                        const convertedTime = finalDate.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'});
                        
                        outputEl.innerHTML += `<p>${market.flag} ${market.name}: <span class="font-bold text-white">${convertedTime}</span></p>`;

                    } catch(e) { console.error("Erro na conversão de tempo", e); }
                });
            }

            async function fetchCurrencyRates() {
                try {
                    const response = await fetch('https://cdn.jsdelivr.net/npm/@fawazahmed0/currency-api@latest/v1/currencies/usd.json');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();

                    if (data && data.usd) {
                        const upperCaseRates = {};
                        for (const key in data.usd) {
                            upperCaseRates[key.toUpperCase()] = data.usd[key];
                        }
                        currencyRates = upperCaseRates;
                        currencyRates['USD'] = 1; 
                    } else {
                         throw new Error("Estrutura de dados inválida da API de moeda");
                    }
                } catch (error) {
                    console.error("Erro ao buscar taxas de câmbio:", error);
                    showToast("Erro ao buscar cotações.", "⚠️");
                    if (typeof currencyRates === 'undefined' || currencyRates === null || Object.keys(currencyRates).length === 0) {
                         currencyRates = { USD: 1, BRL: 5.0, EUR: 0.9, GBP: 0.8, CHF: 0.9 };
                    }
                }
            }
            
            function updateCurrency(sourceInput) {
                const sourceCode = sourceInput.dataset.code;
                const sourceValue = parseFloat(sourceInput.value);

                if (Object.keys(currencyRates).length === 0) {
                    return; 
                }

                if (isNaN(sourceValue) || !currencyRates[sourceCode]) {
                    if(sourceInput.value === '') {
                        currencies.forEach(c => {
                            if (c.code !== sourceCode) {
                                document.getElementById(`currency-${c.code}`).value = '';
                            }
                        });
                    }
                    return;
                }

                const valueInUSD = sourceValue / currencyRates[sourceCode];

                currencies.forEach(currency => {
                    if (currency.code !== sourceCode && currencyRates[currency.code]) {
                        const targetInput = document.getElementById(`currency-${currency.code}`);
                        const convertedValue = valueInUSD * currencyRates[currency.code];
                        targetInput.value = convertedValue.toFixed(4);
                    }
                });
            }

            function toggleMode() {
                isDetailedMode = !isDetailedMode;
                const detailedSections = document.getElementById('detailed-sections');
                const toggleText = document.getElementById('mode-toggle-text');
                const toggleIcon = document.getElementById('mode-toggle-icon');

                if (isDetailedMode) {
                    detailedSections.style.maxHeight = detailedSections.scrollHeight + 'px';
                    detailedSections.style.opacity = '1';
                    detailedSections.style.transform = 'translateY(0)';
                    toggleText.textContent = 'Detalhado';
                    toggleIcon.textContent = '👁️';

                } else {
                    detailedSections.style.maxHeight = '0';
                    detailedSections.style.opacity = '0';
                    detailedSections.style.transform = 'translateY(-20px)';
                    toggleText.textContent = 'Compacto';
                    toggleIcon.textContent = '📦';
                }
            }
            
            function renderSessionChart() {
                const ctx = document.getElementById('sessionsChart').getContext('2d');
                const labels = Array.from({ length: 24 }, (_, i) => `${i}:00`);
                
                const brtOffset = -3;
                
                const datasets = [
                    { name: 'Tóquio', tz: 'Asia/Tokyo', open: 9, close: 15, color: 'rgba(239, 68, 68, 0.6)' }, // red
                    { name: 'Londres', tz: 'Europe/London', open: 8, close: 16.5, color: 'rgba(59, 130, 246, 0.6)' }, // blue
                    { name: 'NY', tz: 'America/New_York', open: 9.5, close: 16, color: 'rgba(34, 197, 94, 0.6)' } // green
                ].map(session => {
                    const nowInTz = new Date(new Date().toLocaleString('en-US', { timeZone: session.tz }));
                    const nowInUtc = new Date(nowInTz.getTime() + nowInTz.getTimezoneOffset() * 60000);
                    const utcOffset = (nowInUtc - new Date()) / 3600000;
                    
                    const openBrt = (session.open + utcOffset - brtOffset + 24) % 24;
                    const closeBrt = (session.close + utcOffset - brtOffset + 24) % 24;

                    const data = labels.map((_, i) => {
                       if (openBrt < closeBrt) {
                           return i >= openBrt && i < closeBrt ? 1 : 0;
                       } else {
                           return i >= openBrt || i < closeBrt ? 1 : 0;
                       }
                    });

                    return {
                        label: session.name,
                        data: data,
                        borderColor: session.color.replace('0.6', '1'),
                        backgroundColor: session.color,
                        stepped: true,
                        pointRadius: 0,
                        borderWidth: 2,
                    };
                });
                
                new Chart(ctx, {
                    type: 'line',
                    data: { labels, datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { display: false, max: 1.5 },
                            x: { 
                                ticks: { color: '#9CA3AF', maxRotation: 0, minRotation: 0, autoSkip: true, maxTicksLimit: 8 }, 
                                grid: { color: 'rgba(255, 255, 255, 0.1)' } 
                            }
                        },
                        plugins: { legend: { labels: { color: '#D1D5DB' } } }
                    }
                });
            }

            function setupEventListeners() {
                document.getElementById('mode-toggle').addEventListener('click', toggleMode);
                document.getElementById('time-input').addEventListener('input', updateTimeConverter);
                document.getElementById('timezone-select').addEventListener('change', updateTimeConverter);
                
                document.getElementById('currency-list').addEventListener('input', (e) => {
                    if (e.target.tagName === 'INPUT') {
                        updateCurrency(e.target);
                    }
                });

                document.getElementById('session-alerts').addEventListener('change', (e) => {
                     if (e.target.classList.contains('toggle-checkbox')) {
                         const marketId = e.target.dataset.market;
                         alertSettings[marketId] = e.target.checked;
                     }
                });
            }
            
            function init() {
                const clocksContainer = document.querySelector('#clocks .grid');
                clocksContainer.innerHTML = markets.map(createClock).join('');

                const sessionsContainer = document.querySelector('#sessions .space-y-4');
                sessionsContainer.innerHTML = ['tokyo', 'london', 'ny'].map(id => createSession(markets.find(m => m.id === id))).join('');

                const timeZoneSelect = document.getElementById('timezone-select');
                timeZoneSelect.innerHTML = markets.map(m => `<option value="${m.timeZone}">${m.flag} ${m.name}</option>`).join('');

                const currencyList = document.getElementById('currency-list');
                currencyList.innerHTML = currencies.map(createCurrencyInput).join('');
                
                const sessionAlertsContainer = document.getElementById('session-alerts');
                sessionAlertsContainer.innerHTML = ['tokyo', 'london', 'ny'].map(id => createSessionAlertToggle(markets.find(m => m.id === id))).join('');

                const economicEventsContainer = document.getElementById('economic-events');
                economicEventsContainer.innerHTML = economicEventsMock.map(e => `
                    <div class="flex justify-between items-center bg-gray-700 p-2 rounded-lg">
                        <span>${e.time} - ${e.event}</span>
                        <span class="text-red-400 font-bold">${'🐂'.repeat(e.impact)}</span>
                    </div>
                `).join('');

                setupEventListeners();
                fetchCurrencyRates().then(() => {
                     setInterval(fetchCurrencyRates, 60000);
                });
                
                setInterval(() => {
                    updateClocks();
                    updateSessions();
                }, 1000);
                
                renderSessionChart();

                const detailedSections = document.getElementById('detailed-sections');
                detailedSections.style.maxHeight = detailedSections.scrollHeight + 'px';
            }

            init();
        });
    </script>
</body>
</html>


