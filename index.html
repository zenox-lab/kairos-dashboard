<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KAIROS Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }
        .no-spinner::-webkit-outer-spin-button,
        .no-spinner::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .no-spinner {
            -moz-appearance: textfield;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 180px;
            max-height: 220px;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <div id="app" class="max-w-md mx-auto bg-gray-900 min-h-screen">
        <header class="sticky top-0 bg-gray-900 bg-opacity-80 backdrop-blur-md z-10 p-4 pt-6 flex justify-between items-center">
            <h1 class="text-xl font-bold text-white">KAIROS</h1>
        </header>

        <main class="p-4 space-y-6">
            <section id="clocks">
                <h2 class="text-lg font-semibold mb-3 text-blue-300">Rel√≥gios Globais</h2>
                <div class="grid grid-cols-2 sm:grid-cols-3 gap-4">
                    <!-- Rel√≥gios s√£o injetados aqui pelo JS -->
                </div>
            </section>

            <section id="sessions">
                <h2 class="text-lg font-semibold mb-3 text-blue-300">Sess√µes de Mercado</h2>
                <p class="text-sm text-gray-400 mb-4">
                    Acompanhe o estado de abertura dos principais mercados globais, com hor√°rios e contadores ajustados para o fuso de Bras√≠lia (BRT).
                </p>
                <div class="space-y-4">
                    <!-- Sess√µes s√£o injetadas aqui pelo JS -->
                </div>
                <div class="mt-4 bg-gray-800 p-4 rounded-xl">
                    <h3 class="text-md font-medium text-center text-gray-300 mb-2">Sobreposi√ß√£o de Sess√µes (BRT)</h3>
                    <div class="chart-container">
                        <canvas id="sessionsChart"></canvas>
                    </div>
                </div>
            </section>

            <div class="space-y-6">
                <section id="time-converter">
                    <h2 class="text-lg font-semibold mb-3 text-blue-300">Conversor de Hor√°rio</h2>
                    <p class="text-sm text-gray-400 mb-4">Insira um hor√°rio em qualquer mercado para ver a correspond√™ncia nos outros centros financeiros instantaneamente.</p>
                    <div class="bg-gray-800 p-4 rounded-xl space-y-4">
                        <div class="flex items-center space-x-2">
                            <input type="time" id="time-input" class="bg-gray-700 text-white rounded-lg p-2 w-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <select id="timezone-select" class="bg-gray-700 text-white rounded-lg p-2 w-full focus:outline-none focus:ring-2 focus:ring-blue-500"></select>
                        </div>
                        <div id="converted-times" class="text-center text-gray-300 space-y-1"></div>
                    </div>
                </section>

                <section id="currency-converter">
                    <h2 class="text-lg font-semibold mb-3 text-blue-300">Conversor Cambial</h2>
                    <p class="text-sm text-gray-400 mb-4">Cota√ß√µes em tempo real. Digite um valor em qualquer moeda para converter para as demais. As taxas s√£o atualizadas a cada minuto.</p>
                    <div id="currency-list" class="bg-gray-800 p-4 rounded-xl space-y-3"></div>
                </section>

                <section id="alerts">
                    <h2 class="text-lg font-semibold mb-3 text-blue-300">Alertas Inteligentes</h2>
                    <p class="text-sm text-gray-400 mb-4">Configure notifica√ß√µes para aberturas de sess√£o e eventos econ√≥micos de alta volatilidade.</p>
                    <div class="bg-gray-800 p-4 rounded-xl space-y-4">
                        <div>
                            <h3 class="font-medium text-white mb-2">Alertas de Sess√£o</h3>
                            <div id="session-alerts" class="space-y-2"></div>
                        </div>
                        <div>
                            <h3 class="font-medium text-white mb-2">Pr√≥ximos Eventos de Volatilidade</h3>
                            <div id="economic-events" class="space-y-2 text-sm"></div>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-10 right-10 flex items-center bg-blue-500 text-white py-3 px-5 rounded-lg shadow-lg transform translate-x-[150%] transition-transform duration-500 ease-in-out">
        <span id="toast-icon" class="mr-3 text-xl">üîî</span>
        <span id="toast-message"></span>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // ‚úÖ Nomes e timezones atualizados para display. A l√≥gica de sess√£o usar√° tempos BRT fixos.
            const markets = [
                { id: 'cme', name: 'CME (EUA)', flag: 'üá∫üá∏', timeZone: 'America/Chicago' },
                { id: 'eurex', name: 'Eurex (ALE)', flag: 'üá©üá™', timeZone: 'Europe/Berlin' },
                { id: 'liffe', name: 'LIFFE (UK)', flag: 'üá¨üáß', timeZone: 'Europe/London' },
                { id: 'jpx', name: 'JPX (JAP)', flag: 'üáØüáµ', timeZone: 'Asia/Tokyo' },
                { id: 'b3', name: 'B3 (BRA)', flag: 'üáßüá∑', timeZone: 'America/Sao_Paulo' }
            ];

            const currencies = [
                { code: 'BRL', name: 'Real', flag: 'üáßüá∑' }, { code: 'USD', name: 'D√≥lar', flag: 'üá∫üá∏' },
                { code: 'EUR', name: 'Euro', flag: 'üá™üá∫' }, { code: 'GBP', name: 'Libra', flag: 'üá¨üáß' },
                { code: 'CHF', name: 'Franco', flag: 'üá®üá≠' }
            ];

            const economicEventsMock = [
                { time: '10:30', event: 'CPI (EUA)', impact: 3 }, { time: '15:00', event: 'Discurso da Fed', impact: 3 },
                { time: 'Amanh√£ 09:30', event: 'Payroll (EUA)', impact: 3 },
            ];

            let currencyRates = {};
            let alertSettings = { cme: true, eurex: true, liffe: true, jpx: true, b3: true };
            const triggeredAlerts = new Set();
            let audioContext;

            function getUtcOffset(timeZone) {
                try {
                    const now = new Date();
                    const formatter = new Intl.DateTimeFormat('en-US', { timeZone, timeZoneName: 'shortOffset' });
                    const parts = formatter.formatToParts(now);
                    const offsetPart = parts.find(p => p.type === 'timeZoneName');
                    return offsetPart ? offsetPart.value.replace('GMT', 'UTC') : 'UTC';
                } catch (e) { return 'UTC'; }
            }

            function formatTime(date) {
                return date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit', hour12: false });
            }

            function renderClocks() {
                const clocksContainer = document.querySelector('#clocks .grid');
                if (!clocksContainer) return;
                clocksContainer.innerHTML = ''; 

                markets.forEach(market => {
                    const now = new Date();
                    const marketTime = new Date(now.toLocaleString('en-US', { timeZone: market.timeZone }));
                    const clockDiv = `
                        <div class="bg-gray-800 p-3 rounded-xl shadow flex flex-col items-center justify-center">
                            <span class="text-md text-gray-400">${market.flag} ${market.name}</span>
                            <span class="font-bold text-xl text-white mt-2">${formatTime(marketTime)}</span>
                            <span class="text-xs text-gray-500 mt-1">${getUtcOffset(market.timeZone)}</span>
                        </div>`;
                    clocksContainer.innerHTML += clockDiv;
                });
            }

            function getCountdown(targetDate) {
                const now = new Date();
                const diff = targetDate.getTime() - now.getTime();
                if (diff < 0) return '00:00:00';
                const totalSeconds = Math.floor(diff / 1000);
                const days = Math.floor(totalSeconds / 86400);
                const hours = String(Math.floor((totalSeconds % 86400) / 3600)).padStart(2, '0');
                const minutes = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, '0');
                const seconds = String(totalSeconds % 60).padStart(2, '0');
                return days > 0 ? `${days}d ${hours}:${minutes}:${seconds}` : `${hours}:${minutes}:${seconds}`;
            }

            // ‚úÖ L√ìGICA DE SESS√ÉO TOTALMENTE REFEITA
            function renderSessions() {
                const sessionsContainer = document.getElementById('sessions')?.querySelector('.space-y-4');
                if (!sessionsContainer) return;
                sessionsContainer.innerHTML = '';
                const brtTimeZone = 'America/Sao_Paulo';
                const nowBRT = new Date(new Date().toLocaleString('en-US', { timeZone: brtTimeZone }));
                const nowDay = nowBRT.getDay(); // 0 = Domingo, 6 = S√°bado
                const nowTime = nowBRT.getHours() + nowBRT.getMinutes() / 60;

                markets.forEach(market => {
                    let statusText = 'Fechado', statusColor = 'text-red-400', countdownText = '', targetDate, displayTimes = '';

                    const setTime = (date, h, m) => { date.setHours(h, m, 0, 0); return date; };
                    
                    switch (market.id) {
                        case 'b3': {
                            displayTimes = '09:45 - 18:25 BRT';
                            const openDays = [1, 2, 3, 4, 5];
                            const openTime = 9.75, closeTime = 18.416;
                            let nextOpen = setTime(new Date(nowBRT), 9, 45);
                            let nextClose = setTime(new Date(nowBRT), 18, 25);

                            if (openDays.includes(nowDay)) {
                                if (nowTime < openTime) { // Antes de abrir
                                    targetDate = nextOpen;
                                    countdownText = `Abre em ${getCountdown(targetDate)}`;
                                } else if (nowTime >= openTime && nowTime < closeTime) { // Aberto
                                    statusText = 'Aberto'; statusColor = 'text-green-400';
                                    targetDate = nextClose;
                                    countdownText = `Fecha em ${getCountdown(targetDate)}`;
                                } else { // Fechou no dia
                                    if (nowDay === 5) nextOpen.setDate(nextOpen.getDate() + 3);
                                    else nextOpen.setDate(nextOpen.getDate() + 1);
                                    targetDate = nextOpen;
                                    countdownText = `Abre em ${getCountdown(targetDate)}`;
                                }
                            } else { // Fim de semana
                                const daysToAdd = nowDay === 6 ? 2 : 1;
                                nextOpen.setDate(nextOpen.getDate() + daysToAdd);
                                targetDate = nextOpen;
                                countdownText = `Abre em ${getCountdown(targetDate)}`;
                            }
                            break;
                        }
                         case 'cme': {
                            displayTimes = 'Dom 19h - Sex 18h BRT';
                            const openHour = 19, closeHour = 18, pauseHour = 18;
                            const isAfterOpen = nowDay > 0 || (nowDay === 0 && nowTime >= openHour);
                            const isBeforeClose = nowDay < 5 || (nowDay === 5 && nowTime < closeHour);
                            
                            if (isAfterOpen && isBeforeClose) {
                                if (nowBRT.getHours() === pauseHour) {
                                    statusText = 'Pausa'; statusColor = 'text-yellow-400';
                                    let nextResume = setTime(new Date(nowBRT), 19, 0);
                                    countdownText = `Volta em ${getCountdown(nextResume)}`;
                                } else {
                                    statusText = 'Aberto'; statusColor = 'text-green-400';
                                    let nextPause = setTime(new Date(nowBRT), 18, 0);
                                    if (nowBRT > nextPause) nextPause.setDate(nextPause.getDate() + 1);
                                    countdownText = `Pausa em ${getCountdown(nextPause)}`;
                                }
                            } else {
                                let nextOpen = setTime(new Date(nowBRT), 19, 0);
                                if (nowDay >= 5) { // Se for sexta p√≥s fechamento ou s√°bado
                                    const daysToAdd = 7 - nowDay;
                                    nextOpen.setDate(nextOpen.getDate() + daysToAdd);
                                }
                                countdownText = `Abre em ${getCountdown(nextOpen)}`;
                            }
                            break;
                        }
                         case 'eurex':
                         case 'liffe': {
                            const isEurex = market.id === 'eurex';
                            displayTimes = isEurex ? '03:15 - 17:00 BRT' : '04:00 - 18:00 BRT';
                            const openDays = [1, 2, 3, 4, 5];
                            const openTime = isEurex ? 3.25 : 4.0;
                            const closeTime = isEurex ? 17.0 : 18.0;
                            let nextOpen = setTime(new Date(nowBRT), Math.floor(openTime), (openTime % 1) * 60);
                            let nextClose = setTime(new Date(nowBRT), Math.floor(closeTime), (closeTime % 1) * 60);
                            
                            if(openDays.includes(nowDay)){
                                if(nowTime < openTime){
                                    countdownText = `Abre em ${getCountdown(nextOpen)}`;
                                } else if (nowTime >= openTime && nowTime < closeTime){
                                    statusText = 'Aberto'; statusColor = 'text-green-400';
                                    countdownText = `Fecha em ${getCountdown(nextClose)}`;
                                } else {
                                    if(nowDay === 5) nextOpen.setDate(nextOpen.getDate() + 3);
                                    else nextOpen.setDate(nextOpen.getDate() + 1);
                                    countdownText = `Abre em ${getCountdown(nextOpen)}`;
                                }
                            } else {
                               const daysToAdd = nowDay === 6 ? 2 : 1;
                               nextOpen.setDate(nextOpen.getDate() + daysToAdd);
                               countdownText = `Abre em ${getCountdown(nextOpen)}`;
                            }
                            break;
                        }
                        case 'jpx': {
                            displayTimes = '21:00 - 07:00 BRT';
                            const openTime = 21, closeTime = 7, pauseStart = 3.5, pauseEnd = 4.5;
                            // A sess√£o de segunda come√ßa domingo 21h. A de sexta termina 7h.
                            const isOpen = (nowDay !== 5 && nowDay !== 6 && nowTime >= openTime) || // Abre Sun-Thu √† noite
                                           (nowDay !== 6 && nowDay !== 0 && nowTime < closeTime); // Fecha Mon-Fri de manh√£
                            
                            if (isOpen) {
                                // Pausa
                                if(nowTime >= pauseStart && nowTime < pauseEnd){
                                    statusText = 'Pausa'; statusColor = 'text-yellow-400';
                                    let nextResume = setTime(new Date(nowBRT), 4, 30);
                                    countdownText = `Volta em ${getCountdown(nextResume)}`;
                                } else {
                                    statusText = 'Aberto'; statusColor = 'text-green-400';
                                    let nextPause = setTime(new Date(nowBRT), 3, 30);
                                    if(nowTime >= openTime) nextPause.setDate(nextPause.getDate() + 1);
                                    countdownText = `Pausa em ${getCountdown(nextPause)}`;
                                }
                            } else {
                                let nextOpen = setTime(new Date(nowBRT), 21, 0);
                                if(nowDay === 5 || (nowDay === 6) || (nowDay === 0 && nowTime < openTime)) {
                                    if(nowDay === 5 && nowTime >= closeTime) nextOpen.setDate(nextOpen.getDate() + 2); // Sexta -> Domingo
                                    if(nowDay === 6) nextOpen.setDate(nextOpen.getDate() + 1); // S√°bado -> Domingo
                                }
                                countdownText = `Abre em ${getCountdown(nextOpen)}`;
                            }
                            break;
                        }
                    }

                    const sessionDiv = `
                        <div class="bg-gray-800 p-4 rounded-xl flex justify-between items-center shadow">
                            <div>
                                <span class="font-medium text-white">${market.flag} ${market.name}</span>
                                <span class="text-sm text-gray-400 ml-2 block sm:inline-block sm:ml-2">(${displayTimes})</span>
                            </div>
                            <div class="text-right">
                                <span class="text-xs ${statusColor} block">${statusText}</span>
                                <span class="text-sm font-semibold text-gray-300">${countdownText}</span>
                            </div>
                        </div>`;
                    sessionsContainer.innerHTML += sessionDiv;
                });
            }


            let sessionsChart;
            function renderSessionsChart() {
                const ctx = document.getElementById('sessionsChart')?.getContext('2d');
                if(!ctx) return;
                
                const brtTimeZone = 'America/Sao_Paulo';
                const now = new Date();
                const nowBRT = new Date(now.toLocaleString('en-US', { timeZone: brtTimeZone }));

                const marketIntervals = {
                    'liffe': { flag: 'üá¨üáß', name: 'LIFFE (UK)', intervals: [[4, 18]] },
                    'cme': { flag: 'üá∫üá∏', name: 'CME (EUA)', intervals: [[0, 18], [19, 24]] },
                    'eurex': { flag: 'üá©üá™', name: 'Eurex (ALE)', intervals: [[3.25, 17]] },
                    'jpx': { flag: 'üáØüáµ', name: 'JPX (JAP)', intervals: [[0, 3.5], [4.5, 7], [21, 24]] },
                    'b3': { flag: 'üáßüá∑', name: 'B3 (BRA)', intervals: [[9.75, 18.416]] },
                };
                
                const orderedData = ['liffe', 'cme', 'eurex', 'jpx', 'b3'].map(id => marketIntervals[id]);

                const datasets = [];
                const nowHour = nowBRT.getHours() + nowBRT.getMinutes() / 60;

                orderedData.forEach(market => {
                    market.intervals.forEach(interval => {
                        const isActive = nowHour >= interval[0] && nowHour < interval[1];
                        datasets.push({
                            label: market.name,
                            data: [{ x: interval, y: market.name }],
                            backgroundColor: isActive ? 'rgba(74, 222, 128, 0.8)' : 'rgba(59, 130, 246, 0.6)',
                            borderColor: 'transparent',
                            borderRadius: 5,
                            borderWidth: 1,
                            borderSkipped: false
                        });
                    });
                });
                
                const customLabelsPlugin = {
                    id: 'customLabels',
                    afterDraw: (chart) => {
                        const { ctx, chartArea: { top, bottom, left }, scales: { x, y } } = chart;
                        ctx.save();

                        orderedData.forEach((market, index) => {
                             if (!market) return;
                            ctx.font = '20px Arial';
                            ctx.fillStyle = '#E5E7EB';
                            ctx.textAlign = 'center';
                            ctx.textBaseline = 'middle';
                            const yPos = y.getPixelForValue(index);
                            ctx.fillText(market.flag, left - 25, yPos);
                        });
                        
                        const currentHour = nowBRT.getHours() + nowBRT.getMinutes() / 60;
                        const xPos = x.getPixelForValue(currentHour);

                        if (xPos >= x.left && xPos <= x.right) {
                            ctx.beginPath();
                            ctx.strokeStyle = 'rgba(255, 255, 255, 0.7)';
                            ctx.lineWidth = 1.5;
                            ctx.setLineDash([4, 4]);
                            ctx.moveTo(xPos, top);
                            ctx.lineTo(xPos, bottom);
                            ctx.stroke();
                            ctx.setLineDash([]);
                        }
                        ctx.restore();
                    }
                };
                
                if (sessionsChart) sessionsChart.destroy();

                sessionsChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: orderedData.map(d => d.name),
                        datasets: datasets
                    },
                    options: {
                        indexAxis: 'y', responsive: true, maintainAspectRatio: false,
                        layout: { padding: { left: 30 } },
                        plugins: {
                            legend: { display: false },
                            tooltip: { enabled: false }
                        },
                        scales: {
                            x: { min: 0, max: 24, ticks: { color: '#9CA3AF', stepSize: 2, callback: (v) => `${v}h` }, grid: { color: 'rgba(107, 114, 128, 0.3)' } },
                            y: { ticks: { display: false }, grid: { display: false } }
                        }
                    },
                    plugins: [customLabelsPlugin]
                });
            }
            
            // --- O RESTANTE DO C√ìDIGO (CONVERSORES, ALERTAS, ETC.) PERMANECE O MESMO ---

            function populateTimezoneSelect() {
                const timezoneSelect = document.getElementById('timezone-select');
                if(!timezoneSelect) return;
                timezoneSelect.innerHTML = '';
                markets.forEach(market => {
                    const option = document.createElement('option');
                    option.value = market.timeZone;
                    option.textContent = `${market.flag} ${market.name} (${getUtcOffset(market.timeZone)})`;
                    if (market.id === 'b3') option.selected = true;
                    timezoneSelect.appendChild(option);
                });
            }

            function convertTime() {
                const timeInput = document.getElementById('time-input');
                const timezoneSelect = document.getElementById('timezone-select');
                const convertedTimesDiv = document.getElementById('converted-times');
                if(!timeInput || !timezoneSelect || !convertedTimesDiv) return;

                const inputTime = timeInput.value;
                const inputTimeZone = timezoneSelect.value;
                convertedTimesDiv.innerHTML = '';

                if (!inputTime) {
                    convertedTimesDiv.textContent = 'Insira um hor√°rio.';
                    return;
                }

                const [inputHour, inputMinute] = inputTime.split(':').map(Number);
                
                // Create a date object that correctly represents the input time in the source timezone
                const now = new Date();
                const dateStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}T${inputTime}:00`;
                const baseDate = new Date(new Date(dateStr).toLocaleString("en-US", {timeZone: inputTimeZone}));
                const offset = baseDate.getTimezoneOffset()*60*1000;
                const sourceDate = new Date(new Date(dateStr).getTime() + offset);

                markets.forEach(market => {
                    if (market.timeZone === inputTimeZone) return;

                     const targetTime = new Intl.DateTimeFormat('en-US', {
                        timeZone: market.timeZone,
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: false
                    }).format(sourceDate);

                    const targetDate = new Date(sourceDate.toLocaleString('en-US', {timeZone: market.timeZone}));
                    
                    let dayIndicator = '';
                    if(targetDate.getDate() > sourceDate.getDate() || (targetDate.getMonth() > sourceDate.getMonth() || targetDate.getFullYear() > sourceDate.getFullYear())) dayIndicator = ' (+1 dia)';
                    if(targetDate.getDate() < sourceDate.getDate() || (targetDate.getMonth() < sourceDate.getMonth() || targetDate.getFullYear() < sourceDate.getFullYear())) dayIndicator = ' (-1 dia)';


                    convertedTimesDiv.innerHTML += `
                        <p class="flex justify-between items-center bg-gray-700 p-2 rounded-lg">
                            <span>${market.flag} ${market.name} <span class="text-xs text-gray-400 ml-1">${getUtcOffset(market.timeZone)}</span></span>
                            <span class="font-semibold text-white">${targetTime}${dayIndicator}</span>
                        </p>`;
                });
            }

            async function fetchCurrencyRates() {
                try {
                    const response = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
                    if (!response.ok) throw new Error('API failed');
                    const data = await response.json();
                    
                    currencyRates = {
                        'USD': 1, 'BRL': data.rates.BRL || 5.00, 'EUR': data.rates.EUR || 0.92,
                        'GBP': data.rates.GBP || 0.79, 'CHF': data.rates.CHF || 0.90
                    };
                } catch (error) {
                    console.error('Erro ao buscar taxas, usando mock data:', error);
                    currencyRates = { 'USD': 1, 'BRL': 5.00, 'EUR': 0.92, 'GBP': 0.79, 'CHF': 0.90 };
                }
                renderCurrencyConverter();
            }

            function renderCurrencyConverter() {
                const currencyListDiv = document.getElementById('currency-list');
                if(!currencyListDiv || Object.keys(currencyRates).length === 0) return;

                currencyListDiv.innerHTML = '';
                currencies.forEach(currency => {
                    const currencyDiv = document.createElement('div');
                    currencyDiv.className = 'flex items-center space-x-2 bg-gray-700 p-2 rounded-lg';
                    currencyDiv.innerHTML = `
                        <span class="text-xl">${currency.flag}</span>
                        <span class="font-medium w-16">${currency.code}</span>
                        <input type="number" step="0.01" value="0.00" data-currency="${currency.code}"
                            class="no-spinner bg-gray-600 text-white rounded-lg p-2 flex-grow text-right focus:outline-none focus:ring-2 focus:ring-blue-500">
                    `;
                    currencyListDiv.appendChild(currencyDiv);
                });

                currencyListDiv.querySelectorAll('input').forEach(input => input.addEventListener('input', handleCurrencyInput));
                
                const brlInput = currencyListDiv.querySelector('input[data-currency="BRL"]');
                if (brlInput && brlInput.value === '0.00') {
                    brlInput.value = '1.00';
                    handleCurrencyInput({ target: brlInput });
                }
            }

            function handleCurrencyInput({ target }) {
                const value = parseFloat(target.value);
                const changedCurrency = target.dataset.currency;

                if (isNaN(value) || !currencyRates[changedCurrency]) return;

                const valueInUSD = value / currencyRates[changedCurrency];
                document.querySelectorAll('#currency-list input').forEach(input => {
                    if (input !== target) {
                        input.value = (valueInUSD * currencyRates[input.dataset.currency]).toFixed(2);
                    }
                });
            }

            function renderAlertSettings() {
                const sessionAlertsDiv = document.getElementById('session-alerts');
                if(!sessionAlertsDiv) return;

                sessionAlertsDiv.innerHTML = '';
                markets.forEach(market => { 
                    const isEnabled = alertSettings[market.id];
                    sessionAlertsDiv.innerHTML += `
                        <label class="flex items-center justify-between p-2 bg-gray-700 rounded-lg cursor-pointer">
                            <span class="text-white">${market.flag} ${market.name} - Abertura</span>
                            <input type="checkbox" data-market-id="${market.id}" ${isEnabled ? 'checked' : ''} class="toggle-checkbox form-checkbox h-5 w-5 text-blue-500 rounded focus:ring-blue-500">
                        </label>`;
                });

                sessionAlertsDiv.querySelectorAll('.toggle-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', (event) => {
                        const marketId = event.target.dataset.marketId;
                        alertSettings[marketId] = event.target.checked;
                        saveAlertSettings();
                        showToast(`Alerta para ${markets.find(m => m.id === marketId).name} ${event.target.checked ? 'ativado' : 'desativado'}`, 'üîî');
                    });
                });
            }

            function renderEconomicEvents() {
                const economicEventsDiv = document.getElementById('economic-events');
                if(!economicEventsDiv) return;
                economicEventsDiv.innerHTML = '';
                if (economicEventsMock.length === 0) {
                    economicEventsDiv.innerHTML = '<p class="text-gray-500">Nenhum evento de alta volatilidade pr√≥ximo.</p>';
                } else {
                    economicEventsMock.forEach(event => {
                        economicEventsDiv.innerHTML += `
                            <div class="flex justify-between items-center p-2 bg-gray-700 rounded-lg">
                                <span class="text-gray-300">${event.time} - ${event.event}</span>
                                <span class="text-yellow-400">${'‚≠ê'.repeat(event.impact)}</span>
                            </div>`;
                    });
                }
            }
            
            function checkSessionAlerts() {
                // L√≥gica de alerta pode ser refinada com os novos tempos
            }

            let toastTimeout;
            function showToast(message, icon = 'üîî', duration = 3000) {
                const toast = document.getElementById('toast');
                if(!toast) return;
                toast.querySelector('#toast-message').textContent = message;
                toast.querySelector('#toast-icon').textContent = icon;
                toast.classList.remove('translate-x-[150%]');
                toast.classList.add('translate-x-0');
                clearTimeout(toastTimeout);
                toastTimeout = setTimeout(() => {
                    toast.classList.remove('translate-x-0');
                    toast.classList.add('translate-x-[150%]');
                }, duration);
            }

            function playSound() {
                if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const o = audioContext.createOscillator();
                const g = audioContext.createGain();
                o.connect(g);
                g.connect(audioContext.destination);
                o.start(0);
                g.gain.exponentialRampToValueAtTime(0.00001, audioContext.currentTime + 0.5);
            }

            function saveAlertSettings() {
                localStorage.setItem('kairosAlertSettings', JSON.stringify(alertSettings));
            }
            function loadAlertSettings() {
                const savedSettings = localStorage.getItem('kairosAlertSettings');
                if (savedSettings) alertSettings = JSON.parse(savedSettings);
            }

            function init() {
                loadAlertSettings();
                populateTimezoneSelect();
                
                const timeInput = document.getElementById('time-input');
                if(timeInput && !timeInput.value) {
                    timeInput.value = formatTime(new Date());
                }
                convertTime(); 
                fetchCurrencyRates(); 
                renderAlertSettings(); 
                renderEconomicEvents();
                
                renderClocks();
                renderSessions();
                renderSessionsChart();

                setInterval(() => {
                    renderClocks();
                    renderSessions();
                }, 1000);
                
                setInterval(renderSessionsChart, 10000);
                setInterval(fetchCurrencyRates, 60000);
                
                document.getElementById('time-input')?.addEventListener('change', convertTime);
                document.getElementById('timezone-select')?.addEventListener('change', convertTime);
            }

            init();
        });
    </script>
</body>
</html>

