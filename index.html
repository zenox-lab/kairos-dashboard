<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KAIROS Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }
        .no-spinner::-webkit-outer-spin-button,
        .no-spinner::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .no-spinner {
            -moz-appearance: textfield;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 180px; /* Aumentei um pouco a altura para acomodar melhor */
            max-height: 220px;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <div id="app" class="max-w-md mx-auto bg-gray-900 min-h-screen">
        <header class="sticky top-0 bg-gray-900 bg-opacity-80 backdrop-blur-md z-10 p-4 pt-6 flex justify-between items-center">
            <h1 class="text-xl font-bold text-white">KAIROS</h1>
            <!-- Bot√£o de modo removido -->
        </header>

        <main class="p-4 space-y-6">
            <section id="clocks">
                <h2 class="text-lg font-semibold mb-3 text-blue-300">Rel√≥gios Globais</h2>
                <div class="grid grid-cols-2 sm:grid-cols-3 gap-4">
                    <!-- Rel√≥gios s√£o injetados aqui pelo JS -->
                </div>
            </section>

            <section id="sessions">
                <h2 class="text-lg font-semibold mb-3 text-blue-300">Sess√µes de Mercado</h2>
                <p class="text-sm text-gray-400 mb-4">
                    Acompanhe o estado de abertura dos principais mercados globais, com hor√°rios e contadores ajustados para o fuso de Bras√≠lia (BRT).
                </p>
                <div class="space-y-4">
                    <!-- Sess√µes s√£o injetadas aqui pelo JS -->
                </div>
                <div class="mt-4 bg-gray-800 p-4 rounded-xl">
                    <h3 class="text-md font-medium text-center text-gray-300 mb-2">Sobreposi√ß√£o de Sess√µes (BRT)</h3>
                    <div class="chart-container">
                        <canvas id="sessionsChart"></canvas>
                    </div>
                </div>
            </section>

            <!-- Se√ß√µes que antes eram "detalhadas" agora s√£o fixas -->
            <div class="space-y-6">
                <section id="time-converter">
                    <h2 class="text-lg font-semibold mb-3 text-blue-300">Conversor de Hor√°rio</h2>
                    <p class="text-sm text-gray-400 mb-4">Insira um hor√°rio em qualquer mercado para ver a correspond√™ncia nos outros centros financeiros instantaneamente.</p>
                    <div class="bg-gray-800 p-4 rounded-xl space-y-4">
                        <div class="flex items-center space-x-2">
                            <input type="time" id="time-input" class="bg-gray-700 text-white rounded-lg p-2 w-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <select id="timezone-select" class="bg-gray-700 text-white rounded-lg p-2 w-full focus:outline-none focus:ring-2 focus:ring-blue-500"></select>
                        </div>
                        <div id="converted-times" class="text-center text-gray-300 space-y-1"></div>
                    </div>
                </section>

                <section id="currency-converter">
                    <h2 class="text-lg font-semibold mb-3 text-blue-300">Conversor Cambial</h2>
                    <p class="text-sm text-gray-400 mb-4">Cota√ß√µes em tempo real. Digite um valor em qualquer moeda para converter para as demais. As taxas s√£o atualizadas a cada minuto.</p>
                    <div id="currency-list" class="bg-gray-800 p-4 rounded-xl space-y-3"></div>
                </section>

                <section id="alerts">
                    <h2 class="text-lg font-semibold mb-3 text-blue-300">Alertas Inteligentes</h2>
                    <p class="text-sm text-gray-400 mb-4">Configure notifica√ß√µes para aberturas de sess√£o e eventos econ√≥micos de alta volatilidade.</p>
                    <div class="bg-gray-800 p-4 rounded-xl space-y-4">
                        <div>
                            <h3 class="font-medium text-white mb-2">Alertas de Sess√£o</h3>
                            <div id="session-alerts" class="space-y-2"></div>
                        </div>
                        <div>
                            <h3 class="font-medium text-white mb-2">Pr√≥ximos Eventos de Volatilidade</h3>
                            <div id="economic-events" class="space-y-2 text-sm"></div>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-10 right-10 flex items-center bg-blue-500 text-white py-3 px-5 rounded-lg shadow-lg transform translate-x-[150%] transition-transform duration-500 ease-in-out">
        <span id="toast-icon" class="mr-3 text-xl">üîî</span>
        <span id="toast-message"></span>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const markets = [
                { id: 'ny', name: 'Nova Iorque', flag: 'üá∫üá∏', timeZone: 'America/New_York', open: '09:30', close: '16:00' },
                { id: 'frankfurt', name: 'Frankfurt', flag: 'üá™üá∫', timeZone: 'Europe/Berlin', open: '09:00', close: '17:30' },
                { id: 'london', name: 'Londres', flag: 'üá¨üáß', timeZone: 'Europe/London', open: '08:00', close: '16:30' },
                { id: 'tokyo', name: 'T√≥quio', flag: 'üáØüáµ', timeZone: 'Asia/Tokyo', open: '09:00', close: '15:00' },
                { id: 'brasilia', name: 'Bras√≠lia', flag: 'üáßüá∑', timeZone: 'America/Sao_Paulo', open: '10:00', close: '18:00' }
            ];

            const currencies = [
                { code: 'BRL', name: 'Real', flag: 'üáßüá∑' },
                { code: 'USD', name: 'D√≥lar', flag: 'üá∫üá∏' },
                { code: 'EUR', name: 'Euro', flag: 'üá™üá∫' },
                { code: 'GBP', name: 'Libra', flag: 'üá¨üáß' },
                { code: 'CHF', name: 'Franco', flag: 'üá®üá≠' }
            ];

            const economicEventsMock = [
                { time: '10:30', event: 'CPI (EUA)', impact: 3 },
                { time: '15:00', event: 'Discurso da Fed', impact: 3 },
                { time: 'Amanh√£ 09:30', event: 'Payroll (EUA)', impact: 3 },
            ];

            let currencyRates = {};
            let alertSettings = { tokyo: true, london: true, ny: true, frankfurt: true };
            const triggeredAlerts = new Set();
            let audioContext;

            function getUtcOffset(timeZone) {
                try {
                    const now = new Date();
                    const formatter = new Intl.DateTimeFormat('en-US', { timeZone, timeZoneName: 'shortOffset' });
                    const parts = formatter.formatToParts(now);
                    const offsetPart = parts.find(p => p.type === 'timeZoneName');
                    return offsetPart ? offsetPart.value.replace('GMT', 'UTC') : 'UTC';
                } catch (e) {
                    return 'UTC'; // Fallback for invalid timezone
                }
            }

            function formatTime(date) {
                return date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit', hour12: false });
            }

            function renderClocks() {
                const clocksContainer = document.querySelector('#clocks .grid');
                if (!clocksContainer) return;
                clocksContainer.innerHTML = ''; 

                markets.forEach(market => {
                    const now = new Date();
                    const marketTime = new Date(now.toLocaleString('en-US', { timeZone: market.timeZone }));
                    const formattedTime = formatTime(marketTime);
                    const utcOffset = getUtcOffset(market.timeZone);

                    const clockDiv = `
                        <div class="bg-gray-800 p-3 rounded-xl shadow flex flex-col items-center">
                            <span class="text-xl">${market.flag}</span>
                            <span class="text-xs text-gray-400 mt-1">${market.name}</span>
                            <span class="font-bold text-lg text-white">${formattedTime}</span>
                            <span class="text-xs text-gray-500">${utcOffset}</span>
                        </div>
                    `;
                    clocksContainer.innerHTML += clockDiv;
                });
            }

            function getCountdown(targetDate) {
                const now = new Date();
                const diff = targetDate.getTime() - now.getTime();

                if (diff < 0) return '00:00:00';

                const totalSeconds = Math.floor(diff / 1000);
                const hours = String(Math.floor(totalSeconds / 3600)).padStart(2, '0');
                const minutes = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, '0');
                const seconds = String(totalSeconds % 60).padStart(2, '0');

                return `${hours}:${minutes}:${seconds}`;
            }

            function renderSessions() {
                const sessionsContainer = document.getElementById('sessions')?.querySelector('.space-y-4');
                if (!sessionsContainer) return;
                sessionsContainer.innerHTML = '';
                const brtTimeZone = 'America/Sao_Paulo';
                const now = new Date();
                const nowBRT = new Date(now.toLocaleString('en-US', { timeZone: brtTimeZone }));

                markets.forEach(market => {
                    const [openH, openM] = market.open.split(':').map(Number);
                    const [closeH, closeM] = market.close.split(':').map(Number);

                    const marketOpenTime = new Date(now.toLocaleString('en-US', { timeZone: market.timeZone }));
                    marketOpenTime.setHours(openH, openM, 0, 0);

                    const marketCloseTime = new Date(now.toLocaleString('en-US', { timeZone: market.timeZone }));
                    marketCloseTime.setHours(closeH, closeM, 0, 0);

                    const marketOpenBRT = new Date(marketOpenTime.toLocaleString('en-US', { timeZone: brtTimeZone }));
                    const marketCloseBRT = new Date(marketCloseTime.toLocaleString('en-US', { timeZone: brtTimeZone }));
                    
                    if (nowBRT > marketCloseBRT) {
                        marketOpenBRT.setDate(marketOpenBRT.getDate() + 1);
                        marketCloseBRT.setDate(marketCloseBRT.getDate() + 1);
                    }
                    
                    if (marketCloseBRT < marketOpenBRT) {
                         marketCloseBRT.setDate(marketCloseBRT.getDate() + 1);
                    }

                    let statusText = '';
                    let countdownText = '';
                    let statusColor = '';

                    if (nowBRT >= marketOpenBRT && nowBRT < marketCloseBRT) {
                        statusText = 'Aberto';
                        statusColor = 'text-green-400';
                        countdownText = `Fecha em ${getCountdown(marketCloseBRT)}`;
                    } else {
                        statusText = 'Fechado';
                        statusColor = 'text-red-400';
                        countdownText = `Abre em ${getCountdown(marketOpenBRT)}`;
                    }

                    const sessionDiv = `
                        <div class="bg-gray-800 p-4 rounded-xl flex justify-between items-center shadow">
                            <div>
                                <span class="text-xl mr-2">${market.flag}</span>
                                <span class="font-medium text-white">${market.name}</span>
                                <span class="text-sm text-gray-400 ml-2">(${market.open} - ${market.close} ${market.timeZone.split('/')[1].replace('_', ' ')})</span>
                            </div>
                            <div class="text-right">
                                <span class="text-xs ${statusColor} block">${statusText}</span>
                                <span class="text-sm font-semibold text-gray-300">${countdownText}</span>
                            </div>
                        </div>
                    `;
                    sessionsContainer.innerHTML += sessionDiv;
                });
            }

            let sessionsChart;
            function renderSessionsChart() {
                const ctx = document.getElementById('sessionsChart')?.getContext('2d');
                if(!ctx) return;
                
                const brtTimeZone = 'America/Sao_Paulo';
                const now = new Date();
                const nowBRT = new Date(now.toLocaleString('en-US', { timeZone: brtTimeZone }));

                const chartData = markets.map(market => {
                    const [openHour, openMinute] = market.open.split(':').map(Number);
                    const [closeHour, closeMinute] = market.close.split(':').map(Number);

                    const marketOpenTime = new Date(now.toLocaleString('en-US', { timeZone: market.timeZone }));
                    marketOpenTime.setHours(openHour, openMinute, 0, 0);
                    const marketCloseTime = new Date(now.toLocaleString('en-US', { timeZone: market.timeZone }));
                    marketCloseTime.setHours(closeHour, closeMinute, 0, 0);

                    const openTimeBRT = new Date(marketOpenTime.toLocaleString('en-US', { timeZone: brtTimeZone }));
                    const closeTimeBRT = new Date(marketCloseTime.toLocaleString('en-US', { timeZone: brtTimeZone }));

                    if (closeTimeBRT < openTimeBRT) {
                        closeTimeBRT.setDate(closeTimeBRT.getDate() + 1);
                    }
                    
                    let startHour = openTimeBRT.getHours() + openTimeBRT.getMinutes() / 60;
                    let endHour = closeTimeBRT.getHours() + closeTimeBRT.getMinutes() / 60;
                    
                    if (endHour < startHour) endHour += 24;

                    return { name: market.name, flag: market.flag, startHour, endHour };
                });

                const orderedData = [
                    chartData.find(m => m.name === 'Londres'),
                    chartData.find(m => m.name === 'Nova Iorque'),
                    chartData.find(m => m.name === 'Frankfurt'),
                    chartData.find(m => m.name === 'T√≥quio'),
                    chartData.find(m => m.name === 'Bras√≠lia'),
                ].filter(Boolean);

                const datasets = orderedData.map((market) => {
                    const nowHour = nowBRT.getHours() + nowBRT.getMinutes() / 60;
                    const isActive = nowHour >= market.startHour && nowHour < market.endHour;
                    
                    return {
                        label: market.name,
                        data: [{
                            x: [market.startHour, market.endHour],
                            y: market.name
                        }],
                        backgroundColor: isActive ? 'rgba(74, 222, 128, 0.8)' : 'rgba(59, 130, 246, 0.6)',
                        borderColor: 'transparent',
                        borderRadius: 5,
                        borderWidth: 1,
                        borderSkipped: false
                    };
                });
                
                // ‚úÖ NOVO: Plugin para desenhar a linha do tempo e as bandeiras
                const customLabelsPlugin = {
                    id: 'customLabels',
                    afterDraw: (chart) => {
                        const { ctx, chartArea: { top, bottom, left }, scales: { x, y } } = chart;
                        ctx.save();

                        // 1. Desenhar bandeiras
                        y.ticks.forEach((tick, index) => {
                            const market = orderedData[index];
                            if (!market) return;

                            ctx.font = '20px Arial';
                            ctx.fillStyle = '#E5E7EB'; // Cor do texto
                            ctx.textAlign = 'center';
                            ctx.textBaseline = 'middle';
                            // Posi√ß√£o Y da bandeira alinhada com a barra
                            const yPos = y.getPixelForValue(index);
                            ctx.fillText(market.flag, left - 25, yPos);
                        });

                        // 2. Desenhar linha vertical do tempo atual
                        const currentHour = nowBRT.getHours() + nowBRT.getMinutes() / 60;
                        const xPos = x.getPixelForValue(currentHour);

                        if (xPos >= x.left && xPos <= x.right) {
                            ctx.beginPath();
                            ctx.strokeStyle = 'rgba(255, 255, 255, 0.7)';
                            ctx.lineWidth = 1.5;
                            ctx.setLineDash([4, 4]); // Linha pontilhada
                            ctx.moveTo(xPos, top);
                            ctx.lineTo(xPos, bottom);
                            ctx.stroke();
                            ctx.setLineDash([]); // Resetar
                        }

                        ctx.restore();
                    }
                };
                
                if (sessionsChart) sessionsChart.destroy();

                sessionsChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: orderedData.map(d => d.name),
                        datasets: datasets
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        layout: {
                            padding: {
                                left: 30 // Espa√ßo para as bandeiras
                            }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: (context) => {
                                        const market = orderedData[context.datasetIndex];
                                        const start = market.startHour;
                                        const end = market.endHour;
                                        const startMinute = Math.round((start % 1) * 60);
                                        const endMinute = Math.round((end % 1) * 60);
                                        const startStr = `${String(Math.floor(start % 24)).padStart(2, '0')}:${String(startMinute).padStart(2, '0')}`;
                                        const endStr = `${String(Math.floor(end % 24)).padStart(2, '0')}:${String(endMinute).padStart(2, '0')}`;
                                        return `${market.name}: ${startStr} - ${endStr} BRT`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                min: 0,
                                max: 24,
                                ticks: {
                                    color: '#9CA3AF',
                                    stepSize: 2,
                                    callback: (value) => `${value}h`
                                },
                                grid: { color: 'rgba(107, 114, 128, 0.3)' }
                            },
                            y: {
                                ticks: { 
                                    display: false // Oculta os nomes para mostrar s√≥ as bandeiras
                                },
                                grid: { display: false }
                            }
                        }
                    },
                    plugins: [customLabelsPlugin] // ‚úÖ Registra o novo plugin
                });
            }

            function populateTimezoneSelect() {
                const timezoneSelect = document.getElementById('timezone-select');
                if(!timezoneSelect) return;
                timezoneSelect.innerHTML = '';
                markets.forEach(market => {
                    const option = document.createElement('option');
                    option.value = market.timeZone;
                    option.textContent = `${market.name} (${getUtcOffset(market.timeZone)})`;
                    if (market.id === 'brasilia') option.selected = true;
                    timezoneSelect.appendChild(option);
                });
            }

            function convertTime() {
                const timeInput = document.getElementById('time-input');
                const timezoneSelect = document.getElementById('timezone-select');
                const convertedTimesDiv = document.getElementById('converted-times');
                if(!timeInput || !timezoneSelect || !convertedTimesDiv) return;

                const inputTime = timeInput.value;
                const inputTimeZone = timezoneSelect.value;
                convertedTimesDiv.innerHTML = '';

                if (!inputTime) {
                    convertedTimesDiv.textContent = 'Insira um hor√°rio.';
                    return;
                }

                const [inputHour, inputMinute] = inputTime.split(':').map(Number);
                const baseDate = new Date();
                const tempDateForOrigin = new Date(baseDate.toLocaleString('en-US', { timeZone: inputTimeZone }));
                baseDate.setHours(inputHour, inputMinute, 0, 0);
                
                const dayOffset = (tempDateForOrigin.getDate() - baseDate.getDate());
                if(dayOffset !== 0) baseDate.setDate(baseDate.getDate() - dayOffset);


                markets.forEach(market => {
                    if (market.timeZone === inputTimeZone) return;

                    const convertedTimeStr = baseDate.toLocaleTimeString('en-US', { timeZone: market.timeZone, hour: '2-digit', minute: '2-digit', hour12: false });
                    const convertedDate = new Date(baseDate.toLocaleString('en-US', {timeZone: market.timeZone}));
                    
                    const diffDays = convertedDate.getDate() - baseDate.getDate();
                    let dayIndicator = '';
                    if (diffDays === 1 || diffDays < -1) dayIndicator = ' (+1 dia)';
                    if (diffDays === -1 || diffDays > 1) dayIndicator = ' (-1 dia)';

                    convertedTimesDiv.innerHTML += `
                        <p class="flex justify-between items-center bg-gray-700 p-2 rounded-lg">
                            <span>${market.flag} ${market.name} <span class="text-xs text-gray-400 ml-1">${getUtcOffset(market.timeZone)}</span></span>
                            <span class="font-semibold text-white">${convertedTimeStr}${dayIndicator}</span>
                        </p>`;
                });
            }

            async function fetchCurrencyRates() {
                try {
                    const response = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
                    if (!response.ok) throw new Error('API failed');
                    const data = await response.json();
                    
                    currencyRates = {
                        'USD': 1, 'BRL': data.rates.BRL || 5.00, 'EUR': data.rates.EUR || 0.92,
                        'GBP': data.rates.GBP || 0.79, 'CHF': data.rates.CHF || 0.90
                    };
                } catch (error) {
                    console.error('Erro ao buscar taxas, usando mock data:', error);
                    currencyRates = { 'USD': 1, 'BRL': 5.00, 'EUR': 0.92, 'GBP': 0.79, 'CHF': 0.90 };
                }
                renderCurrencyConverter();
            }

            function renderCurrencyConverter() {
                const currencyListDiv = document.getElementById('currency-list');
                if(!currencyListDiv || Object.keys(currencyRates).length === 0) return;

                currencyListDiv.innerHTML = '';
                currencies.forEach(currency => {
                    const currencyDiv = document.createElement('div');
                    currencyDiv.className = 'flex items-center space-x-2 bg-gray-700 p-2 rounded-lg';
                    currencyDiv.innerHTML = `
                        <span class="text-xl">${currency.flag}</span>
                        <span class="font-medium w-16">${currency.code}</span>
                        <input type="number" step="0.01" value="0.00" data-currency="${currency.code}"
                            class="no-spinner bg-gray-600 text-white rounded-lg p-2 flex-grow text-right focus:outline-none focus:ring-2 focus:ring-blue-500">
                    `;
                    currencyListDiv.appendChild(currencyDiv);
                });

                currencyListDiv.querySelectorAll('input').forEach(input => input.addEventListener('input', handleCurrencyInput));
                
                const brlInput = currencyListDiv.querySelector('input[data-currency="BRL"]');
                if (brlInput && brlInput.value === '0.00') {
                    brlInput.value = '1.00';
                    handleCurrencyInput({ target: brlInput });
                }
            }

            function handleCurrencyInput({ target }) {
                const value = parseFloat(target.value);
                const changedCurrency = target.dataset.currency;

                if (isNaN(value) || !currencyRates[changedCurrency]) return;

                const valueInUSD = value / currencyRates[changedCurrency];
                document.querySelectorAll('#currency-list input').forEach(input => {
                    if (input !== target) {
                        input.value = (valueInUSD * currencyRates[input.dataset.currency]).toFixed(2);
                    }
                });
            }

            function renderAlertSettings() {
                const sessionAlertsDiv = document.getElementById('session-alerts');
                if(!sessionAlertsDiv) return;

                sessionAlertsDiv.innerHTML = '';
                markets.filter(m => m.id !== 'brasilia').forEach(market => { 
                    const isEnabled = alertSettings[market.id];
                    sessionAlertsDiv.innerHTML += `
                        <label class="flex items-center justify-between p-2 bg-gray-700 rounded-lg cursor-pointer">
                            <span class="text-white">${market.flag} ${market.name} - Abertura</span>
                            <input type="checkbox" data-market-id="${market.id}" ${isEnabled ? 'checked' : ''} class="toggle-checkbox form-checkbox h-5 w-5 text-blue-500 rounded focus:ring-blue-500">
                        </label>`;
                });

                sessionAlertsDiv.querySelectorAll('.toggle-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', (event) => {
                        const marketId = event.target.dataset.marketId;
                        alertSettings[marketId] = event.target.checked;
                        saveAlertSettings();
                        showToast(`Alerta para ${markets.find(m => m.id === marketId).name} ${event.target.checked ? 'ativado' : 'desativado'}`, 'üîî');
                    });
                });
            }

            function renderEconomicEvents() {
                const economicEventsDiv = document.getElementById('economic-events');
                if(!economicEventsDiv) return;

                economicEventsDiv.innerHTML = '';
                if (economicEventsMock.length === 0) {
                    economicEventsDiv.innerHTML = '<p class="text-gray-500">Nenhum evento de alta volatilidade pr√≥ximo.</p>';
                    return;
                }
                economicEventsMock.forEach(event => {
                    economicEventsDiv.innerHTML += `
                        <div class="flex justify-between items-center p-2 bg-gray-700 rounded-lg">
                            <span class="text-gray-300">${event.time} - ${event.event}</span>
                            <span class="text-yellow-400">${'‚≠ê'.repeat(event.impact)}</span>
                        </div>`;
                });
            }
            
            function checkSessionAlerts() {
                const nowBRT = new Date(new Date().toLocaleString('en-US', { timeZone: 'America/Sao_Paulo' }));

                markets.forEach(market => {
                    if (!alertSettings[market.id]) return;

                    const [openH, openM] = market.open.split(':').map(Number);
                    const marketOpenTime = new Date(new Date().toLocaleString('en-US', { timeZone: market.timeZone }));
                    marketOpenTime.setHours(openH, openM, 0, 0);
                    const marketOpenTimeBRT = new Date(marketOpenTime.toLocaleString('en-US', { timeZone: 'America/Sao_Paulo' }));
                    
                    const fiveMinutesBeforeOpen = new Date(marketOpenTimeBRT.getTime() - 5 * 60000);

                    const triggerKey = `${market.id}-${fiveMinutesBeforeOpen.getHours()}:${fiveMinutesBeforeOpen.getMinutes()}`;

                    if (nowBRT.getHours() === fiveMinutesBeforeOpen.getHours() && nowBRT.getMinutes() === fiveMinutesBeforeOpen.getMinutes() && !triggeredAlerts.has(triggerKey)) {
                        showToast(`Abertura de ${market.name} em 5 minutos!`, 'üîî');
                        playSound();
                        triggeredAlerts.add(triggerKey);
                        setTimeout(() => triggeredAlerts.delete(triggerKey), 61000); 
                    }
                });
            }

            let toastTimeout;
            function showToast(message, icon = 'üîî', duration = 3000) {
                const toast = document.getElementById('toast');
                const toastMessage = document.getElementById('toast-message');
                const toastIcon = document.getElementById('toast-icon');
                if(!toast || !toastMessage || !toastIcon) return;

                clearTimeout(toastTimeout);
                toastMessage.textContent = message;
                toastIcon.textContent = icon;
                toast.classList.remove('translate-x-[150%]');
                toast.classList.add('translate-x-0');

                toastTimeout = setTimeout(() => {
                    toast.classList.remove('translate-x-0');
                    toast.classList.add('translate-x-[150%]');
                }, duration);
            }

            function playSound() {
                if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                oscillator.type = 'sine';
                oscillator.frequency.value = 440; 
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.5, audioContext.currentTime + 0.1);
                gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.5);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            }

            function saveAlertSettings() {
                localStorage.setItem('kairosAlertSettings', JSON.stringify(alertSettings));
            }
            function loadAlertSettings() {
                const savedSettings = localStorage.getItem('kairosAlertSettings');
                if (savedSettings) alertSettings = JSON.parse(savedSettings);
            }

            function init() {
                loadAlertSettings();
                populateTimezoneSelect();
                
                const timeInput = document.getElementById('time-input');
                if(timeInput && !timeInput.value) {
                    timeInput.value = formatTime(new Date());
                }
                convertTime(); 
                fetchCurrencyRates(); 
                renderAlertSettings(); 
                renderEconomicEvents();
                
                // Initial renders
                renderClocks();
                renderSessions();
                renderSessionsChart();

                setInterval(() => {
                    renderClocks();
                    renderSessions();
                    checkSessionAlerts();
                }, 1000);
                
                // Less frequent updates
                setInterval(renderSessionsChart, 10000); // Chart update every 10s
                setInterval(fetchCurrencyRates, 60000); // Rates update every minute
                
                document.getElementById('time-input')?.addEventListener('change', convertTime);
                document.getElementById('timezone-select')?.addEventListener('change', convertTime);
            }

            init();
        });
    </script>
</body>
</html>

